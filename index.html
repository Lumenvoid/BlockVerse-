<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>BlockVerse Studio - Create & Play</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/luaparse/0.3.1/luaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;600;700;800&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            font-family: 'Nunito', sans-serif;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        h1, h2, h3, .title-font {
            font-family: 'Fredoka One', cursive;
        }
        .code-font {
            font-family: 'Fira Code', monospace;
        }
        
        body {
            overscroll-behavior: none;
            position: fixed;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #0f0f23;
        }

        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .glass-dark {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .gradient-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        .animate-float {
            animation: float 3s ease-in-out infinite;
        }

        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(102, 126, 234, 0.5); }
            50% { box-shadow: 0 0 40px rgba(102, 126, 234, 0.8); }
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.2);
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,0.3);
        }

        .btn-press:active {
            transform: scale(0.95);
        }

        /* Code Editor Styles */
        .code-editor {
            background: #1e1e1e;
            color: #d4d4d4;
            line-height: 1.5;
            tab-size: 4;
        }
        .code-editor textarea {
            background: transparent;
            color: transparent;
            caret-color: white;
            z-index: 1;
        }
        .code-editor pre {
            z-index: 0;
        }
        .syntax-keyword { color: #569cd6; }
        .syntax-string { color: #ce9178; }
        .syntax-number { color: #b5cea8; }
        .syntax-comment { color: #6a9955; }
        .syntax-function { color: #dcdcaa; }

        /* Admin Panel */
        .admin-panel {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-left: 3px solid #e94560;
        }

        /* Shop Items */
        .shop-item {
            transition: all 0.3s ease;
        }
        .shop-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        /* Console */
        .console-log { color: #d4d4d4; }
        .console-error { color: #f48771; }
        .console-warn { color: #dcdcaa; }
        .console-info { color: #4fc1ff; }

        /* Safe Areas */
        .safe-top { padding-top: env(safe-area-inset-top); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }

        .toast {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(-20px);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            font-weight: bold;
            z-index: 10000;
            opacity: 0;
            transition: all 0.3s;
        }
        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* Game UI Elements */
        .joystick-area {
            background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0.05) 70%);
            border: 2px solid rgba(255,255,255,0.3);
        }
        .joystick-knob {
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.9), rgba(200,200,200,0.8));
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        /* Tool Selection */
        .tool-btn.active {
            background: rgba(255,255,255,0.3);
            border-color: white;
        }

        /* Property Panel */
        .property-row {
            display: grid;
            grid-template-columns: 100px 1fr;
            gap: 8px;
            align-items: center;
            padding: 4px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        /* Scripting Panel */
        .script-tab {
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        .script-tab.active {
            border-bottom-color: #4ECDC4;
            background: rgba(78, 205, 196, 0.1);
        }

        /* Admin Badge */
        .admin-badge {
            background: linear-gradient(135deg, #e94560 0%, #ff6b6b 100%);
            animation: admin-pulse 2s infinite;
        }
        @keyframes admin-pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(233, 69, 96, 0.4); }
            50% { box-shadow: 0 0 0 10px rgba(233, 69, 96, 0); }
        }
    </style>
</head>
<body class="text-white antialiased">

    <!-- Toast -->
    <div id="toast" class="toast"></div>

    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 gradient-primary flex flex-col items-center justify-center z-[100]">
        <div class="text-6xl mb-4 animate-float">ðŸŽ®</div>
        <h1 class="text-4xl mb-2">BlockVerse Studio</h1>
        <p class="text-white/70 mb-8">Loading Developer Tools...</p>
        <div class="w-64 h-2 bg-white/20 rounded-full overflow-hidden">
            <div id="loadingBar" class="h-full bg-white rounded-full transition-all duration-300" style="width: 0%"></div>
        </div>
    </div>

    <!-- Auth Container -->
    <div id="authContainer" class="hidden fixed inset-0 gradient-primary flex items-center justify-center p-4">
        <!-- Login/Register forms here (same as before) -->
        <div id="loginForm" class="glass rounded-3xl p-6 w-full max-w-sm">
            <div class="text-center mb-6">
                <div class="text-5xl mb-3 animate-float inline-block">ðŸŒŸ</div>
                <h1 class="text-3xl mb-1">Welcome Back!</h1>
                <p class="text-white/70 text-sm">Login to continue creating</p>
            </div>
            <form onsubmit="handleLogin(event)" class="space-y-4">
                <input type="text" id="loginUsername" required placeholder="Username" class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white placeholder-white/50 focus:outline-none focus:border-white/50">
                <input type="password" id="loginPassword" required placeholder="Password" class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white placeholder-white/50 focus:outline-none focus:border-white/50">
                <button type="submit" class="w-full py-4 bg-white text-purple-600 rounded-2xl font-bold btn-press">Login</button>
            </form>
            <div class="mt-4 text-center">
                <button onclick="showRegister()" class="text-white/70 hover:text-white text-sm">Create Account</button>
            </div>
        </div>

        <div id="registerForm" class="hidden glass rounded-3xl p-6 w-full max-w-sm max-h-[90vh] overflow-y-auto custom-scrollbar">
            <div class="text-center mb-6">
                <h1 class="text-3xl mb-1">Create Account</h1>
            </div>
            <form onsubmit="handleRegister(event)" class="space-y-3">
                <input type="text" id="regName" required placeholder="Full Name" class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white placeholder-white/50">
                <input type="text" id="regUsername" required placeholder="Username" class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white placeholder-white/50">
                <input type="date" id="regBirthday" required class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white">
                <input type="password" id="regPassword" required placeholder="Password" class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white placeholder-white/50">
                <input type="password" id="regConfirmPassword" required placeholder="Confirm Password" class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white placeholder-white/50">
                <button type="submit" class="w-full py-4 bg-white text-purple-600 rounded-2xl font-bold btn-press">Create Account</button>
            </form>
            <div class="mt-4 text-center">
                <button onclick="showLogin()" class="text-white/70 hover:text-white text-sm">Already have an account?</button>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="app" class="hidden fixed inset-0 gradient-primary flex flex-col">
        <!-- Header -->
        <header class="glass safe-top px-4 py-3 flex justify-between items-center z-40 shrink-0">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-white/20 flex items-center justify-center text-xl">ðŸŽ®</div>
                <div>
                    <h1 class="text-lg leading-none">BlockVerse Studio</h1>
                    <p class="text-xs text-white/60" id="onlineStatus">ðŸŸ¢ Studio Mode</p>
                </div>
            </div>
            
            <div class="flex items-center gap-3">
                <div class="flex items-center gap-2 bg-yellow-500/20 px-3 py-1.5 rounded-full border border-yellow-400/30">
                    <span class="text-lg">ðŸ’°</span>
                    <span id="coinDisplay" class="font-bold text-yellow-300">0</span>
                </div>
                <div class="flex items-center gap-2 bg-purple-500/20 px-3 py-1.5 rounded-full border border-purple-400/30" id="robuxDisplay" style="display: none;">
                    <span class="text-lg">ðŸ’Ž</span>
                    <span id="robuxAmount" class="font-bold text-purple-300">0</span>
                </div>
                <button onclick="toggleProfileMenu()" class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center btn-press relative">
                    <div id="headerAvatar" class="w-8 h-8 rounded-full bg-[#4ECDC4]"></div>
                    <div id="adminIndicator" class="hidden absolute -bottom-1 -right-1 w-4 h-4 bg-red-500 rounded-full border-2 border-purple-600 text-[8px] flex items-center justify-center">A</div>
                </button>
            </div>
        </header>

        <!-- Profile Menu -->
        <div id="profileMenu" class="hidden absolute top-16 right-4 w-56 glass-dark rounded-2xl p-2 z-50">
            <div class="px-3 py-3 border-b border-white/10 mb-2">
                <p class="font-bold" id="menuUsername">Player</p>
                <p class="text-xs text-white/50" id="menuRole">Player</p>
            </div>
            <button onclick="showSection('profile')" class="w-full text-left px-3 py-2 rounded-lg hover:bg-white/10 text-sm flex items-center gap-2">
                <i class="fas fa-user"></i> Profile
            </button>
            <button onclick="showSection('create')" class="w-full text-left px-3 py-2 rounded-lg hover:bg-white/10 text-sm flex items-center gap-2">
                <i class="fas fa-hammer"></i> Create
            </button>
            <button onclick="showSection('shop')" class="w-full text-left px-3 py-2 rounded-lg hover:bg-white/10 text-sm flex items-center gap-2">
                <i class="fas fa-shopping-bag"></i> Shop
            </button>
            <button id="adminMenuBtn" onclick="showSection('admin')" class="hidden w-full text-left px-3 py-2 rounded-lg hover:bg-red-500/20 text-sm flex items-center gap-2 text-red-300">
                <i class="fas fa-shield-alt"></i> Admin Panel
            </button>
            <div class="border-t border-white/10 mt-2 pt-2">
                <button onclick="logout()" class="w-full text-left px-3 py-2 rounded-lg hover:bg-red-500/20 text-sm text-red-300">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <main id="mainContent" class="flex-1 overflow-hidden relative">
            
            <!-- Play Section -->
            <section id="playSection" class="section h-full overflow-y-auto custom-scrollbar p-4 pb-24">
                <div class="mb-4">
                    <h2 class="text-2xl font-bold mb-1">Discover Worlds</h2>
                    <p class="text-white/60 text-sm">Play games created by the community</p>
                </div>

                <div class="flex gap-2 overflow-x-auto no-scrollbar mb-6">
                    <button class="shrink-0 px-4 py-2 rounded-full bg-white text-purple-600 font-bold text-sm">All</button>
                    <button class="shrink-0 px-4 py-2 rounded-full glass font-bold text-sm text-white/80">Popular</button>
                    <button class="shrink-0 px-4 py-2 rounded-full glass font-bold text-sm text-white/80">New</button>
                    <button class="shrink-0 px-4 py-2 rounded-full glass font-bold text-sm text-white/80">My Games</button>
                </div>

                <div class="grid grid-cols-2 gap-3" id="gamesGrid"></div>
            </section>

            <!-- Create Section (Studio) -->
            <section id="createSection" class="section hidden h-full flex flex-col">
                <!-- Studio Toolbar -->
                <div class="glass px-4 py-2 flex items-center gap-2 overflow-x-auto no-scrollbar shrink-0">
                    <button onclick="studioNew()" class="px-3 py-1.5 rounded-lg bg-white/10 hover:bg-white/20 text-sm font-bold flex items-center gap-2 shrink-0">
                        <i class="fas fa-file"></i> New
                    </button>
                    <button onclick="studioSave()" class="px-3 py-1.5 rounded-lg bg-white/10 hover:bg-white/20 text-sm font-bold flex items-center gap-2 shrink-0">
                        <i class="fas fa-save"></i> Save
                    </button>
                    <button onclick="studioPublish()" class="px-3 py-1.5 rounded-lg bg-green-500/20 hover:bg-green-500/30 text-green-300 text-sm font-bold flex items-center gap-2 shrink-0">
                        <i class="fas fa-upload"></i> Publish
                    </button>
                    <div class="w-px h-6 bg-white/20 mx-1"></div>
                    <button onclick="studioUndo()" class="px-3 py-1.5 rounded-lg bg-white/10 hover:bg-white/20 text-sm shrink-0">
                        <i class="fas fa-undo"></i>
                    </button>
                    <button onclick="studioRedo()" class="px-3 py-1.5 rounded-lg bg-white/10 hover:bg-white/20 text-sm shrink-0">
                        <i class="fas fa-redo"></i>
                    </button>
                    <div class="w-px h-6 bg-white/20 mx-1"></div>
                    <button onclick="studioPlay()" class="px-3 py-1.5 rounded-lg bg-blue-500/20 hover:bg-blue-500/30 text-blue-300 text-sm font-bold flex items-center gap-2 shrink-0">
                        <i class="fas fa-play"></i> Test
                    </button>
                    <button onclick="toggleScriptEditor()" class="px-3 py-1.5 rounded-lg bg-purple-500/20 hover:bg-purple-500/30 text-purple-300 text-sm font-bold flex items-center gap-2 shrink-0">
                        <i class="fas fa-code"></i> Script
                    </button>
                </div>

                <!-- Studio Workspace -->
                <div class="flex-1 flex overflow-hidden">
                    <!-- Left Panel - Tools & Explorer -->
                    <div class="w-64 glass-dark border-r border-white/10 flex flex-col shrink-0">
                        <!-- Tools -->
                        <div class="p-3 border-b border-white/10">
                            <h3 class="text-xs font-bold text-white/50 uppercase mb-2">Tools</h3>
                            <div class="grid grid-cols-4 gap-1">
                                <button onclick="selectTool('select')" class="tool-btn active aspect-square rounded-lg bg-white/10 flex items-center justify-center text-lg" title="Select">
                                    <i class="fas fa-mouse-pointer"></i>
                                </button>
                                <button onclick="selectTool('move')" class="tool-btn aspect-square rounded-lg bg-white/10 flex items-center justify-center text-lg" title="Move">
                                    <i class="fas fa-arrows-alt"></i>
                                </button>
                                <button onclick="selectTool('rotate')" class="tool-btn aspect-square rounded-lg bg-white/10 flex items-center justify-center text-lg" title="Rotate">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                                <button onclick="selectTool('scale')" class="tool-btn aspect-square rounded-lg bg-white/10 flex items-center justify-center text-lg" title="Scale">
                                    <i class="fas fa-expand"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Explorer -->
                        <div class="flex-1 overflow-y-auto custom-scrollbar p-3">
                            <h3 class="text-xs font-bold text-white/50 uppercase mb-2">Explorer</h3>
                            <div id="explorerTree" class="space-y-1 text-sm">
                                <div class="flex items-center gap-2 p-1 rounded hover:bg-white/10 cursor-pointer">
                                    <i class="fas fa-cube text-blue-400"></i>
                                    <span>Workspace</span>
                                </div>
                                <div class="flex items-center gap-2 p-1 rounded hover:bg-white/10 cursor-pointer pl-6">
                                    <i class="fas fa-square text-gray-400"></i>
                                    <span>Baseplate</span>
                                </div>
                                <div class="flex items-center gap-2 p-1 rounded hover:bg-white/10 cursor-pointer pl-6">
                                    <i class="fas fa-cube text-red-400"></i>
                                    <span>SpawnLocation</span>
                                </div>
                                <div class="flex items-center gap-2 p-1 rounded hover:bg-white/10 cursor-pointer">
                                    <i class="fas fa-users text-green-400"></i>
                                    <span>Players</span>
                                </div>
                                <div class="flex items-center gap-2 p-1 rounded hover:bg-white/10 cursor-pointer">
                                    <i class="fas fa-lightbulb text-yellow-400"></i>
                                    <span>Lighting</span>
                                </div>
                                <div class="flex items-center gap-2 p-1 rounded hover:bg-white/10 cursor-pointer">
                                    <i class="fas fa-code text-purple-400"></i>
                                    <span>ServerScriptService</span>
                                </div>
                                <div class="flex items-center gap-2 p-1 rounded hover:bg-white/10 cursor-pointer pl-6" onclick="selectScript('gameLogic')">
                                    <i class="fas fa-file-code text-purple-300"></i>
                                    <span>GameLogic</span>
                                </div>
                            </div>
                        </div>

                        <!-- Properties -->
                        <div class="h-48 border-t border-white/10 p-3 overflow-y-auto custom-scrollbar">
                            <h3 class="text-xs font-bold text-white/50 uppercase mb-2">Properties</h3>
                            <div id="propertiesPanel" class="space-y-2 text-xs">
                                <div class="property-row">
                                    <span class="text-white/60">Name</span>
                                    <input type="text" value="Part" class="bg-white/10 rounded px-2 py-1 w-full text-white">
                                </div>
                                <div class="property-row">
                                    <span class="text-white/60">Position</span>
                                    <div class="flex gap-1">
                                        <input type="number" value="0" class="bg-white/10 rounded px-1 py-1 w-full text-center text-white" placeholder="X">
                                        <input type="number" value="0" class="bg-white/10 rounded px-1 py-1 w-full text-center text-white" placeholder="Y">
                                        <input type="number" value="0" class="bg-white/10 rounded px-1 py-1 w-full text-center text-white" placeholder="Z">
                                    </div>
                                </div>
                                <div class="property-row">
                                    <span class="text-white/60">Color</span>
                                    <input type="color" value="#4ECDC4" class="w-full h-6 rounded cursor-pointer">
                                </div>
                                <div class="property-row">
                                    <span class="text-white/60">Material</span>
                                    <select class="bg-white/10 rounded px-2 py-1 w-full text-white text-xs">
                                        <option>Plastic</option>
                                        <option>Wood</option>
                                        <option>Metal</option>
                                        <option>Neon</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Center - Viewport -->
                    <div class="flex-1 relative bg-gray-900" id="studioViewport">
                        <canvas id="studioCanvas" class="w-full h-full block"></canvas>
                        
                        <!-- Studio Overlay -->
                        <div class="absolute top-4 left-4 glass-dark rounded-lg px-3 py-2 text-xs">
                            <p class="text-white/60">Game: <span class="text-white font-bold" id="studioGameName">Untitled Game</span></p>
                            <p class="text-white/60">Parts: <span class="text-white font-bold" id="partCount">0</span></p>
                        </div>

                        <!-- Insert Menu -->
                        <div class="absolute top-4 right-4 flex flex-col gap-2">
                            <button onclick="insertPart('block')" class="w-10 h-10 rounded-lg glass-dark flex items-center justify-center btn-press" title="Insert Block">
                                <i class="fas fa-cube"></i>
                            </button>
                            <button onclick="insertPart('sphere')" class="w-10 h-10 rounded-lg glass-dark flex items-center justify-center btn-press" title="Insert Sphere">
                                <i class="fas fa-circle"></i>
                            </button>
                            <button onclick="insertPart('cylinder')" class="w-10 h-10 rounded-lg glass-dark flex items-center justify-center btn-press" title="Insert Cylinder">
                                <i class="fas fa-database"></i>
                            </button>
                            <button onclick="insertPart('spawn')" class="w-10 h-10 rounded-lg glass-dark flex items-center justify-center btn-press text-green-400" title="Insert Spawn">
                                <i class="fas fa-flag"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Script Editor Panel (Overlay) -->
                    <div id="scriptEditor" class="hidden absolute inset-0 bg-gray-900 z-50 flex flex-col">
                        <!-- Script Toolbar -->
                        <div class="glass px-4 py-2 flex items-center justify-between shrink-0">
                            <div class="flex items-center gap-4">
                                <button onclick="toggleScriptEditor()" class="text-white/70 hover:text-white">
                                    <i class="fas fa-arrow-left"></i>
                                </button>
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-file-code text-purple-400"></i>
                                    <span class="font-bold">GameLogic.lua</span>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <button onclick="runScript()" class="px-4 py-1.5 rounded-lg bg-green-500/20 text-green-300 text-sm font-bold flex items-center gap-2 btn-press">
                                    <i class="fas fa-play"></i> Run
                                </button>
                                <button onclick="stopScript()" class="px-4 py-1.5 rounded-lg bg-red-500/20 text-red-300 text-sm font-bold flex items-center gap-2 btn-press">
                                    <i class="fas fa-stop"></i> Stop
                                </button>
                            </div>
                        </div>

                        <!-- Script Tabs -->
                        <div class="flex border-b border-white/10 bg-black/20">
                            <button class="script-tab active px-4 py-2 text-sm font-bold flex items-center gap-2">
                                <i class="fas fa-file-code text-purple-400"></i>
                                GameLogic.lua
                                <i class="fas fa-times ml-2 text-white/30 hover:text-white"></i>
                            </button>
                            <button class="script-tab px-4 py-2 text-sm text-white/50 flex items-center gap-2">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>

                        <!-- Editor Area -->
                        <div class="flex-1 flex overflow-hidden">
                            <!-- Line Numbers -->
                            <div class="w-12 bg-gray-800 border-r border-white/10 py-4 text-right pr-2 text-gray-500 text-sm code-font select-none" id="lineNumbers">
                                1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10
                            </div>
                            
                            <!-- Code Area -->
                            <div class="flex-1 relative code-editor">
                                <textarea id="codeInput" class="absolute inset-0 w-full h-full p-4 code-font text-sm resize-none outline-none" spellcheck="false" oninput="updateCodeHighlight()" onscroll="syncScroll()">
-- Welcome to BlockVerse Scripting!
-- This is a Lua-like scripting environment

local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")

-- Function to give player coins
function giveCoins(player, amount)
    player.coins = player.coins + amount
    print("Gave " .. amount .. " coins to " .. player.name)
end

-- Event when player joins
Players.PlayerAdded:Connect(function(player)
    print(player.name .. " joined the game!")
    
    -- Give starter coins
    giveCoins(player, 100)
    
    -- Create welcome message
    local message = Instance.new("Message")
    message.Text = "Welcome " .. player.name .. "!"
    message.Parent = player.PlayerGui
end)

-- Touch event example
local coinPart = Workspace:FindFirstChild("Coin")
if coinPart then
    coinPart.Touched:Connect(function(hit)
        local player = Players:GetPlayerFromCharacter(hit.Parent)
        if player then
            giveCoins(player, 50)
            coinPart:Destroy()
        end
    end)
end

-- Game loop
while true do
    wait(1)
    -- Spawn random coins
    if math.random() < 0.1 then
        spawnCoin()
    end
end

function spawnCoin()
    local coin = Instance.new("Part")
    coin.Shape = "Sphere"
    coin.Color = Color3.fromRGB(255, 215, 0)
    coin.Position = Vector3.new(
        math.random(-50, 50),
        10,
        math.random(-50, 50)
    )
    coin.Parent = Workspace
end</textarea>
                                <pre id="codeHighlight" class="absolute inset-0 w-full h-full p-4 code-font text-sm pointer-events-none overflow-hidden"></pre>
                            </div>
                        </div>

                        <!-- Console -->
                        <div class="h-48 border-t border-white/10 bg-black/40 flex flex-col">
                            <div class="flex items-center justify-between px-4 py-2 border-b border-white/10">
                                <span class="text-xs font-bold text-white/50 uppercase">Output</span>
                                <button onclick="clearConsole()" class="text-xs text-white/50 hover:text-white">
                                    <i class="fas fa-trash"></i> Clear
                                </button>
                            </div>
                            <div id="consoleOutput" class="flex-1 overflow-y-auto custom-scrollbar p-4 text-sm code-font space-y-1">
                                <div class="console-info">[System] BlockVerse Studio v1.0.0</div>
                                <div class="console-info">[System] Ready to script!</div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Shop Section -->
            <section id="shopSection" class="section hidden h-full overflow-y-auto custom-scrollbar p-4 pb-24">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold mb-1">Item Shop</h2>
                    <p class="text-white/60 text-sm">Spend your coins and Robux!</p>
                </div>

                <!-- Currency Tabs -->
                <div class="flex gap-2 mb-6">
                    <button onclick="showShopTab('coins')" id="coinsTab" class="flex-1 py-3 rounded-xl bg-yellow-500/20 border border-yellow-500/50 text-yellow-300 font-bold btn-press">
                        <i class="fas fa-coins mr-2"></i> Coins Shop
                    </button>
                    <button onclick="showShopTab('robux')" id="robuxTab" class="flex-1 py-3 rounded-xl glass font-bold btn-press">
                        <i class="fas fa-gem mr-2"></i> Premium Shop
                    </button>
                </div>

                <!-- Coins Shop -->
                <div id="coinsShop" class="space-y-6">
                    <div>
                        <h3 class="text-lg font-bold mb-3 flex items-center gap-2">
                            <i class="fas fa-tshirt text-blue-400"></i> Clothing
                        </h3>
                        <div class="grid grid-cols-2 gap-3" id="clothingItems"></div>
                    </div>
                    
                    <div>
                        <h3 class="text-lg font-bold mb-3 flex items-center gap-2">
                            <i class="fas fa-hat-cowboy text-purple-400"></i> Accessories
                        </h3>
                        <div class="grid grid-cols-2 gap-3" id="accessoryItems"></div>
                    </div>

                    <div>
                        <h3 class="text-lg font-bold mb-3 flex items-center gap-2">
                            <i class="fas fa-bolt text-yellow-400"></i> Power-ups
                        </h3>
                        <div class="grid grid-cols-2 gap-3" id="powerupItems"></div>
                    </div>
                </div>

                <!-- Robux Shop -->
                <div id="robuxShop" class="hidden space-y-6">
                    <div class="glass rounded-2xl p-4 border border-purple-500/30 bg-purple-500/10">
                        <h3 class="font-bold text-purple-300 mb-2">ðŸ’Ž Premium Benefits</h3>
                        <ul class="text-sm text-white/70 space-y-1">
                            <li><i class="fas fa-check text-green-400 mr-2"></i>2x Coins Earned</li>
                            <li><i class="fas fa-check text-green-400 mr-2"></i>Exclusive Items</li>
                            <li><i class="fas fa-check text-green-400 mr-2"></i>Premium Badge</li>
                            <li><i class="fas fa-check text-green-400 mr-2"></i>Priority Support</li>
                        </ul>
                    </div>

                    <div>
                        <h3 class="text-lg font-bold mb-3">Game Passes</h3>
                        <div class="space-y-3" id="gamepassItems"></div>
                    </div>

                    <div>
                        <h3 class="text-lg font-bold mb-3">Developer Products</h3>
                        <div class="grid grid-cols-2 gap-3" id="devProductItems"></div>
                    </div>

                    <div>
                        <h3 class="text-lg font-bold mb-3">Buy Robux</h3>
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="buyRobux(80)" class="glass rounded-xl p-4 text-center btn-press border border-purple-500/30">
                                <div class="text-2xl mb-1">ðŸ’Ž</div>
                                <div class="font-bold">80 Robux</div>
                                <div class="text-xs text-white/50">$0.99</div>
                            </button>
                            <button onclick="buyRobux(400)" class="glass rounded-xl p-4 text-center btn-press border border-purple-500/30">
                                <div class="text-2xl mb-1">ðŸ’Ž</div>
                                <div class="font-bold">400 Robux</div>
                                <div class="text-xs text-white/50">$4.99</div>
                            </button>
                            <button onclick="buyRobux(800)" class="glass rounded-xl p-4 text-center btn-press border border-purple-500/30 relative overflow-hidden">
                                <div class="absolute top-0 right-0 bg-green-500 text-xs px-2 py-0.5 rounded-bl-lg">+50</div>
                                <div class="text-2xl mb-1">ðŸ’Ž</div>
                                <div class="font-bold">800 Robux</div>
                                <div class="text-xs text-white/50">$9.99</div>
                            </button>
                            <button onclick="buyRobux(1700)" class="glass rounded-xl p-4 text-center btn-press border border-purple-500/30 relative overflow-hidden">
                                <div class="absolute top-0 right-0 bg-green-500 text-xs px-2 py-0.5 rounded-bl-lg">+200</div>
                                <div class="text-2xl mb-1">ðŸ’Ž</div>
                                <div class="font-bold">1,700 Robux</div>
                                <div class="text-xs text-white/50">$19.99</div>
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Admin Panel -->
            <section id="adminSection" class="section hidden h-full overflow-y-auto custom-scrollbar p-4 pb-24">
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-12 h-12 rounded-xl admin-badge flex items-center justify-center text-2xl">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold">Admin Panel</h2>
                        <p class="text-red-300 text-sm">Game Owner & Moderator Tools</p>
                    </div>
                </div>

                <!-- Admin Stats -->
                <div class="grid grid-cols-2 gap-3 mb-6">
                    <div class="glass rounded-xl p-4">
                        <div class="text-2xl font-bold text-blue-400" id="adminPlayerCount">0</div>
                        <div class="text-xs text-white/50">Players Online</div>
                    </div>
                    <div class="glass rounded-xl p-4">
                        <div class="text-2xl font-bold text-green-400" id="adminServerCount">1</div>
                        <div class="text-xs text-white/50">Active Servers</div>
                    </div>
                </div>

                <!-- Player Management -->
                <div class="glass rounded-2xl p-4 mb-6">
                    <h3 class="font-bold mb-4 flex items-center gap-2">
                        <i class="fas fa-users text-blue-400"></i> Player Management
                    </h3>
                    <div class="space-y-2 mb-4" id="adminPlayerList">
                        <!-- Populated dynamically -->
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="grid grid-cols-4 gap-2">
                        <button onclick="adminAction('kick')" class="py-2 rounded-lg bg-orange-500/20 text-orange-300 text-xs font-bold btn-press">
                            <i class="fas fa-sign-out-alt block mb-1"></i> Kick
                        </button>
                        <button onclick="adminAction('ban')" class="py-2 rounded-lg bg-red-500/20 text-red-300 text-xs font-bold btn-press">
                            <i class="fas fa-ban block mb-1"></i> Ban
                        </button>
                        <button onclick="adminAction('teleport')" class="py-2 rounded-lg bg-blue-500/20 text-blue-300 text-xs font-bold btn-press">
                            <i class="fas fa-teleport block mb-1"></i> Teleport
                        </button>
                        <button onclick="adminAction('message')" class="py-2 rounded-lg bg-purple-500/20 text-purple-300 text-xs font-bold btn-press">
                            <i class="fas fa-envelope block mb-1"></i> Message
                        </button>
                    </div>
                </div>

                <!-- Server Commands -->
                <div class="glass rounded-2xl p-4 mb-6">
                    <h3 class="font-bold mb-4 flex items-center gap-2">
                        <i class="fas fa-terminal text-green-400"></i> Server Commands
                    </h3>
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="adminCommand" placeholder="Enter command (e.g., ;speed me 100)" 
                            class="flex-1 px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white placeholder-white/50 text-sm code-font">
                        <button onclick="executeCommand()" class="px-4 py-3 rounded-xl bg-green-500/20 text-green-300 font-bold btn-press">
                            <i class="fas fa-play"></i>
                        </button>
                    </div>
                    
                    <div class="space-y-2 text-xs">
                        <div class="flex items-center gap-2 p-2 rounded-lg bg-white/5">
                            <code class="text-green-400">;fly [player]</code>
                            <span class="text-white/50">Toggle fly mode</span>
                        </div>
                        <div class="flex items-center gap-2 p-2 rounded-lg bg-white/5">
                            <code class="text-green-400">;speed [player] [value]</code>
                            <span class="text-white/50">Set walk speed (16-200)</span>
                        </div>
                        <div class="flex items-center gap-2 p-2 rounded-lg bg-white/5">
                            <code class="text-green-400">;jump [player] [value]</code>
                            <span class="text-white/50">Set jump power (50-500)</span>
                        </div>
                        <div class="flex items-center gap-2 p-2 rounded-lg bg-white/5">
                            <code class="text-green-400">;god [player]</code>
                            <span class="text-white/50">Toggle god mode</span>
                        </div>
                        <div class="flex items-center gap-2 p-2 rounded-lg bg-white/5">
                            <code class="text-green-400">;kill [player]</code>
                            <span class="text-white/50">Kill player</span>
                        </div>
                        <div class="flex items-center gap-2 p-2 rounded-lg bg-white/5">
                            <code class="text-green-400">;respawn [player]</code>
                            <span class="text-white/50">Respawn player</span>
                        </div>
                        <div class="flex items-center gap-2 p-2 rounded-lg bg-white/5">
                            <code class="text-green-400">;give [player] [item]</code>
                            <span class="text-white/50">Give item to player</span>
                        </div>
                        <div class="flex items-center gap-2 p-2 rounded-lg bg-white/5">
                            <code class="text-green-400">;time [day/noon/night]</code>
                            <span class="text-white/50">Change time of day</span>
                        </div>
                        <div class="flex items-center gap-2 p-2 rounded-lg bg-white/5">
                            <code class="text-green-400">;shutdown [message]</code>
                            <span class="text-white/50">Shutdown server</span>
                        </div>
                    </div>
                </div>

                <!-- Moderation Log -->
                <div class="glass rounded-2xl p-4">
                    <h3 class="font-bold mb-4 flex items-center gap-2">
                        <i class="fas fa-history text-yellow-400"></i> Moderation Log
                    </h3>
                    <div id="modLog" class="space-y-2 text-xs max-h-48 overflow-y-auto custom-scrollbar">
                        <div class="flex items-center gap-2 text-white/50">
                            <span class="text-white/30">[10:30]</span>
                            <span>System initialized</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Profile Section -->
            <section id="profileSection" class="section hidden h-full overflow-y-auto custom-scrollbar p-4 pb-24">
                <h2 class="text-2xl font-bold mb-6">My Profile</h2>
                <div class="glass rounded-3xl p-6 mb-6 text-center">
                    <div class="w-24 h-24 rounded-full mx-auto mb-4 bg-[#4ECDC4] border-4 border-white/30"></div>
                    <h3 class="text-2xl font-bold" id="profileUsername">Username</h3>
                    <div class="flex justify-center gap-4 mt-4">
                        <div class="text-center">
                            <p class="text-2xl font-bold text-yellow-400" id="profileCoins">0</p>
                            <p class="text-xs text-white/50">Coins</p>
                        </div>
                        <div class="text-center">
                            <p class="text-2xl font-bold text-purple-400" id="profileRobux">0</p>
                            <p class="text-xs text-white/50">Robux</p>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <!-- Bottom Nav -->
        <nav class="glass safe-bottom px-2 py-2 flex justify-around items-center z-40 shrink-0">
            <button onclick="showSection('play')" class="nav-btn active flex flex-col items-center gap-1 p-2 rounded-xl transition-all w-16" data-section="play">
                <i class="fas fa-gamepad text-xl"></i>
                <span class="text-[10px] font-bold">Play</span>
            </button>
            <button onclick="showSection('create')" class="nav-btn flex flex-col items-center gap-1 p-2 rounded-xl transition-all w-16 opacity-60" data-section="create">
                <i class="fas fa-hammer text-xl"></i>
                <span class="text-[10px] font-bold">Create</span>
            </button>
            <button onclick="showSection('shop')" class="nav-btn flex flex-col items-center gap-1 p-2 rounded-xl transition-all w-16 opacity-60" data-section="shop">
                <i class="fas fa-shopping-bag text-xl"></i>
                <span class="text-[10px] font-bold">Shop</span>
            </button>
            <button onclick="showSection('profile')" class="nav-btn flex flex-col items-center gap-1 p-2 rounded-xl transition-all w-16 opacity-60" data-section="profile">
                <i class="fas fa-user text-xl"></i>
                <span class="text-[10px] font-bold">Profile</span>
            </button>
        </nav>
    </div>

    <!-- Game Player Interface -->
    <div id="gamePlayer" class="hidden fixed inset-0 bg-black">
        <canvas id="gameCanvas" class="block w-full h-full"></canvas>
        
        <!-- Game UI -->
        <div class="absolute inset-0 pointer-events-none">
            <!-- Top Bar -->
            <div class="absolute top-0 left-0 right-0 p-4 flex justify-between items-start pointer-events-auto safe-top">
                <button onclick="exitGame()" class="glass-dark px-4 py-2 rounded-full text-sm font-bold">
                    <i class="fas fa-arrow-left mr-1"></i> Leave
                </button>
                <div class="flex gap-2">
                    <div class="glass-dark px-3 py-1.5 rounded-full text-sm flex items-center gap-1">
                        <span>ðŸ’°</span>
                        <span id="gameCoins">0</span>
                    </div>
                    <div class="glass-dark px-3 py-1.5 rounded-full text-sm" id="gamePlayerCount">1</div>
                </div>
            </div>

            <!-- Mobile Controls -->
            <div class="absolute bottom-4 left-4 w-32 h-32 pointer-events-auto">
                <div id="gameJoystick" class="w-full h-full rounded-full joystick-area relative">
                    <div id="gameJoystickKnob" class="absolute w-12 h-12 rounded-full joystick-knob top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2"></div>
                </div>
            </div>

            <div class="absolute bottom-4 right-4 pointer-events-auto flex flex-col gap-2">
                <button id="gameJumpBtn" class="w-16 h-16 rounded-full glass border-2 border-white/30 flex items-center justify-center text-2xl btn-press">
                    <i class="fas fa-arrow-up"></i>
                </button>
            </div>

            <!-- Admin Button (if admin) -->
            <button id="inGameAdminBtn" onclick="toggleInGameAdmin()" class="hidden absolute top-20 right-4 w-12 h-12 rounded-full admin-badge flex items-center justify-center pointer-events-auto btn-press">
                <i class="fas fa-shield-alt"></i>
            </button>

            <!-- In-Game Admin Panel -->
            <div id="inGameAdminPanel" class="hidden absolute top-20 right-4 w-64 glass-dark rounded-2xl p-4 pointer-events-auto max-h-[70vh] overflow-y-auto">
                <h3 class="font-bold mb-3 text-red-300">Quick Admin</h3>
                <div class="space-y-2">
                    <button onclick="quickAdmin('fly')" class="w-full py-2 rounded-lg bg-white/10 text-left px-3 text-sm btn-press">
                        <i class="fas fa-plane mr-2"></i> Toggle Fly
                    </button>
                    <button onclick="quickAdmin('speed')" class="w-full py-2 rounded-lg bg-white/10 text-left px-3 text-sm btn-press">
                        <i class="fas fa-running mr-2"></i> Super Speed
                    </button>
                    <button onclick="quickAdmin('god')" class="w-full py-2 rounded-lg bg-white/10 text-left px-3 text-sm btn-press">
                        <i class="fas fa-shield-alt mr-2"></i> God Mode
                    </button>
                    <button onclick="quickAdmin('invisible')" class="w-full py-2 rounded-lg bg-white/10 text-left px-3 text-sm btn-press">
                        <i class="fas fa-eye-slash mr-2"></i> Invisible
                    </button>
                    <div class="border-t border-white/10 my-2"></div>
                    <input type="text" id="quickCommand" placeholder=";command" class="w-full px-3 py-2 rounded-lg bg-white/10 text-sm mb-2">
                    <button onclick="executeQuickCommand()" class="w-full py-2 rounded-lg bg-green-500/20 text-green-300 text-sm font-bold btn-press">Execute</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== DATA SYSTEM ====================
        const DataSystem = {
            init() {
                if (!localStorage.getItem('blockverse_data')) {
                    localStorage.setItem('blockverse_data', JSON.stringify({
                        accounts: {},
                        games: {},
                        shop: {
                            items: this.generateDefaultItems(),
                            purchases: {}
                        },
                        admin: {
                            bans: [],
                            logs: []
                        }
                    }));
                }
            },

            generateDefaultItems() {
                return {
                    clothing: [
                        { id: 'shirt_red', name: 'Red Shirt', type: 'clothing', price: 100, currency: 'coins', icon: 'ðŸ‘•', color: 'red' },
                        { id: 'shirt_blue', name: 'Blue Shirt', type: 'clothing', price: 100, currency: 'coins', icon: 'ðŸ‘•', color: 'blue' },
                        { id: 'pants_jeans', name: 'Jeans', type: 'clothing', price: 150, currency: 'coins', icon: 'ðŸ‘–', color: 'blue' },
                        { id: 'premium_shirt', name: 'Gold Shirt', type: 'clothing', price: 50, currency: 'robux', icon: 'ðŸ‘•', color: 'gold', premium: true }
                    ],
                    accessories: [
                        { id: 'hat_crown', name: 'Golden Crown', type: 'accessory', price: 500, currency: 'coins', icon: 'ðŸ‘‘', rarity: 'legendary' },
                        { id: 'hat_wings', name: 'Angel Wings', type: 'accessory', price: 750, currency: 'coins', icon: 'ðŸ¦‹', rarity: 'legendary' },
                        { id: 'premium_crown', name: 'Diamond Crown', type: 'accessory', price: 100, currency: 'robux', icon: 'ðŸ‘‘', rarity: 'mythic', premium: true }
                    ],
                    powerups: [
                        { id: 'speed_boost', name: 'Speed Boost', type: 'powerup', price: 50, currency: 'coins', icon: 'âš¡', duration: 300 },
                        { id: 'jump_boost', name: 'Super Jump', type: 'powerup', price: 75, currency: 'coins', icon: 'ðŸ¦˜', duration: 300 },
                        { id: 'coin_magnet', name: 'Coin Magnet', type: 'powerup', price: 100, currency: 'coins', icon: 'ðŸ§²', duration: 600 }
                    ],
                    gamepasses: [
                        { id: 'pass_vip', name: 'VIP Package', description: '2x coins, VIP badge, exclusive items', price: 399, icon: 'ðŸ‘‘', benefits: ['2x Coins', 'VIP Badge', 'Exclusive Items'] },
                        { id: 'pass_builder', name: 'Builder Club', description: 'Extra building tools and colors', price: 199, icon: 'ðŸ—ï¸', benefits: ['Extra Tools', 'More Colors', 'Bigger Worlds'] },
                        { id: 'pass_premium', name: 'Premium Access', description: 'Access to premium-only games', price: 99, icon: 'ðŸ’Ž', benefits: ['Premium Games', 'No Ads', 'Priority Support'] }
                    ],
                    devproducts: [
                        { id: 'dev_coins_1000', name: '1,000 Coins', price: 49, icon: 'ðŸª™', reward: { coins: 1000 } },
                        { id: 'dev_coins_5000', name: '5,000 Coins', price: 199, icon: 'ðŸª™', reward: { coins: 5000 } },
                        { id: 'dev_coins_10000', name: '10,000 Coins', price: 349, icon: 'ðŸª™', reward: { coins: 10000 } }
                    ]
                };
            },

            getData() {
                return JSON.parse(localStorage.getItem('blockverse_data') || '{}');
            },

            saveData(data) {
                localStorage.setItem('blockverse_data', JSON.stringify(data));
            },

            hashPassword(password) {
                return CryptoJS.SHA256(password).toString();
            },

            createAccount(username, data) {
                const db = this.getData();
                db.accounts[username.toLowerCase()] = {
                    ...data,
                    id: 'user_' + Date.now(),
                    createdAt: new Date().toISOString(),
                    coins: 1000,
                    robux: 0,
                    inventory: [],
                    gamepasses: [],
                    friends: [],
                    settings: {},
                    isAdmin: false,
                    isOwner: false,
                    stats: {
                        gamesPlayed: 0,
                        gamesCreated: 0,
                        totalTime: 0
                    }
                };
                this.saveData(db);
                return db.accounts[username.toLowerCase()];
            },

            getAccount(username) {
                const db = this.getData();
                return db.accounts[username.toLowerCase()] || null;
            },

            updateAccount(username, updates) {
                const db = this.getData();
                if (db.accounts[username.toLowerCase()]) {
                    Object.assign(db.accounts[username.toLowerCase()], updates);
                    this.saveData(db);
                    return db.accounts[username.toLowerCase()];
                }
                return null;
            },

            addPurchase(username, item) {
                const db = this.getData();
                if (!db.shop.purchases[username]) {
                    db.shop.purchases[username] = [];
                }
                db.shop.purchases[username].push({
                    ...item,
                    purchasedAt: new Date().toISOString()
                });
                this.saveData(db);
            },

            addModLog(action, target, moderator, reason = '') {
                const db = this.getData();
                db.admin.logs.unshift({
                    action,
                    target,
                    moderator,
                    reason,
                    timestamp: new Date().toISOString()
                });
                if (db.admin.logs.length > 100) db.admin.logs.pop();
                this.saveData(db);
            },

            banUser(username, reason, duration, moderator) {
                const db = this.getData();
                db.admin.bans.push({
                    username: username.toLowerCase(),
                    reason,
                    duration,
                    bannedBy: moderator,
                    bannedAt: new Date().toISOString()
                });
                this.saveData(db);
                this.addModLog('ban', username, moderator, reason);
            }
        };

        // ==================== SCRIPTING ENGINE ====================
        const ScriptEngine = {
            globals: {},
            running: false,
            intervals: [],

            // Mock game services
            services: {
                Players: {
                    players: new Map(),
                    events: {},
                    PlayerAdded: { Connect: function(cb) { ScriptEngine.services.Players.events['added'] = cb; } },
                    PlayerRemoving: { Connect: function(cb) { ScriptEngine.services.Players.events['removing'] = cb; } },
                    GetPlayerFromCharacter: function(char) {
                        return { name: 'Player', coins: 100 };
                    },
                    LocalPlayer: {
                        name: currentUser?.username || 'Player',
                        coins: 1000,
                        UserId: 1,
                        Character: null
                    }
                },
                Workspace: {
                    parts: [],
                    FindFirstChild: function(name) {
                        return { Name: name, Position: { x: 0, y: 0, z: 0 } };
                    },
                    CreatePart: function(props) {
                        console.log('Creating part:', props);
                        return { Name: 'Part', Parent: this };
                    }
                },
                ServerStorage: {},
                ReplicatedStorage: {},
                Lighting: {
                    TimeOfDay: '12:00:00',
                    Brightness: 1
                },
                HttpService: {
                    GetAsync: function(url) { return '{}'; },
                    PostAsync: function(url, data) { return '{}'; },
                    JSONEncode: function(data) { return JSON.stringify(data); },
                    JSONDecode: function(str) { return JSON.parse(str); }
                },
                DataStore: {
                    GetAsync: function(key) { return null; },
                    SetAsync: function(key, value) { return true; },
                    UpdateAsync: function(key, callback) {
                        const current = this.GetAsync(key);
                        const newValue = callback(current);
                        this.SetAsync(key, newValue);
                        return newValue;
                    }
                }
            },

            // Instance constructor
            Instance: class {
                constructor(className) {
                    this.ClassName = className;
                    this.Name = className;
                    this.Parent = null;
                    this.Children = [];
                    this.Properties = {};
                    this.Events = {};
                }

                new(className) {
                    return new ScriptEngine.Instance(className);
                }

                FindFirstChild(name) {
                    return this.Children.find(c => c.Name === name) || null;
                }

                FindFirstChildOfClass(className) {
                    return this.Children.find(c => c.ClassName === className) || null;
                }

                GetChildren() {
                    return this.Children;
                }

                GetDescendants() {
                    let descendants = [];
                    this.Children.forEach(child => {
                        descendants.push(child);
                        descendants = descendants.concat(child.GetDescendants());
                    });
                    return descendants;
                }

                IsA(className) {
                    return this.ClassName === className;
                }

                Destroy() {
                    if (this.Parent) {
                        const idx = this.Parent.Children.indexOf(this);
                        if (idx > -1) this.Parent.Children.splice(idx, 1);
                    }
                }

                Clone() {
                    const clone = new ScriptEngine.Instance(this.ClassName);
                    clone.Name = this.Name;
                    clone.Properties = { ...this.Properties };
                    return clone;
                }

                Connect(eventName, callback) {
                    if (!this.Events[eventName]) this.Events[eventName] = [];
                    this.Events[eventName].push(callback);
                    return { Disconnect: () => {
                        const idx = this.Events[eventName].indexOf(callback);
                        if (idx > -1) this.Events[eventName].splice(idx, 1);
                    }};
                }

                Fire(eventName, ...args) {
                    if (this.Events[eventName]) {
                        this.Events[eventName].forEach(cb => {
                            try { cb(...args); } catch(e) {}
                        });
                    }
                }

                set Parent(parent) {
                    if (this.Parent) {
                        const idx = this.Parent.Children.indexOf(this);
                        if (idx > -1) this.Parent.Children.splice(idx, 1);
                    }
                    this._parent = parent;
                    if (parent) parent.Children.push(this);
                }

                get Parent() { return this._parent; }
            },

            // Built-in functions
            print: function(...args) {
                const msg = args.map(a => typeof a === 'object' ? JSON.stringify(a) : String(a)).join(' ');
                ScriptEngine.log('log', msg);
            },

            warn: function(...args) {
                const msg = args.map(a => typeof a === 'object' ? JSON.stringify(a) : String(a)).join(' ');
                ScriptEngine.log('warn', msg);
            },

            error: function(...args) {
                const msg = args.map(a => typeof a === 'object' ? JSON.stringify(a) : String(a)).join(' ');
                ScriptEngine.log('error', msg);
            },

            wait: function(seconds) {
                return new Promise(resolve => setTimeout(resolve, seconds * 1000));
            },

            spawn: function(fn) {
                setTimeout(fn, 0);
            },

            tick: function() {
                return Date.now() / 1000;
            },

            time: function() {
                return Date.now();
            },

            typeof: function(val) {
                return typeof val;
            },

            log: function(type, message) {
                const consoleEl = document.getElementById('consoleOutput');
                const line = document.createElement('div');
                line.className = `console-${type}`;
                const time = new Date().toLocaleTimeString();
                line.textContent = `[${time}] ${message}`;
                consoleEl.appendChild(line);
                consoleEl.scrollTop = consoleEl.scrollHeight;
            },

            clear: function() {
                document.getElementById('consoleOutput').innerHTML = '';
            },

            // Parse and execute Lua-like code
            execute: async function(code) {
                this.running = true;
                this.clear();
                this.log('info', '[Script] Starting execution...');

                try {
                    // Create execution context
                    const context = {
                        game: this.services,
                        script: { Name: 'GameLogic', Source: code },
                        workspace: this.services.Workspace,
                        print: this.print,
                        warn: this.warn,
                        error: this.error,
                        wait: this.wait,
                        spawn: this.spawn,
                        tick: this.tick,
                        time: this.time,
                        typeof: this.typeof,
                        math: Math,
                        string: String,
                        table: {
                            insert: (arr, val) => arr.push(val),
                            remove: (arr, idx) => arr.splice(idx - 1, 1),
                            sort: (arr, fn) => arr.sort(fn),
                            find: (arr, val) => arr.indexOf(val) + 1,
                            concat: (arr, sep) => arr.join(sep),
                            create: (n, val) => Array(n).fill(val)
                        },
                        Vector3: {
                            new: (x, y, z) => ({ x, y, z, __type: 'Vector3' }),
                            FromNormalId: (id) => {
                                const normals = [{x:0,y:1,z:0}, {x:0,y:-1,z:0}, {x:-1,y:0,z:0}, {x:1,y:0,z:0}, {x:0,y:0,z:-1}, {x:0,y:0,z:1}];
                                return normals[id] || normals[0];
                            }
                        },
                        Color3: {
                            new: (r, g, b) => ({ r: r/255, g: g/255, b: b/255, __type: 'Color3' }),
                            fromRGB: (r, g, b) => ({ r: r/255, g: g/255, b: b/255, __type: 'Color3' }),
                            fromHSV: (h, s, v) => ({ h, s, v, __type: 'Color3' })
                        },
                        CFrame: {
                            new: (...args) => ({ position: {x: args[0]||0, y: args[1]||0, z: args[2]||0 }, __type: 'CFrame' }),
                            Angles: (rx, ry, rz) => ({ rotation: {x: rx, y: ry, z: rz}, __type: 'CFrame' })
                        },
                        Instance: this.Instance,
                        Enum: {
                            KeyCode: {},
                            UserInputType: {},
                            Material: { Plastic: 'Plastic', Wood: 'Wood', Metal: 'Metal', Neon: 'Neon' },
                            SurfaceType: {}
                        },
                        require: (module) => {
                            this.log('warn', 'require() not fully implemented in studio');
                            return {};
                        },
                        loadstring: (str) => {
                            return () => this.execute(str);
                        },
                        pcall: (fn, ...args) => {
                            try {
                                return [true, fn(...args)];
                            } catch(e) {
                                return [false, e.message];
                            }
                        },
                        xpcall: (fn, errHandler, ...args) => {
                            try {
                                return [true, fn(...args)];
                            } catch(e) {
                                return [false, errHandler(e)];
                            }
                        },
                        pairs: (obj) => Object.entries(obj),
                        ipairs: (arr) => arr.entries(),
                        next: (table, index) => {
                            const keys = Object.keys(table);
                            const i = index ? keys.indexOf(index) + 1 : 0;
                            return i < keys.length ? [keys[i], table[keys[i]]] : null;
                        },
                        tonumber: (val) => Number(val),
                        tostring: (val) => String(val),
                        type: (val) => typeof val,
                        unpack: (arr) => arr,
                        select: (index, ...args) => index === '#' ? args.length : args[index - 1],
                        rawget: (table, key) => table[key],
                        rawset: (table, key, value) => { table[key] = value; },
                        rawequal: (a, b) => a === b,
                        getfenv: () => ({}),
                        setfenv: () => {},
                        coroutine: {
                            create: (fn) => ({ fn, status: 'suspended' }),
                            resume: (co, ...args) => {
                                try {
                                    const result = co.fn(...args);
                                    co.status = 'dead';
                                    return [true, result];
                                } catch(e) {
                                    return [false, e.message];
                                }
                            },
                            yield: () => {},
                            status: (co) => co.status,
                            wrap: (fn) => (...args) => fn(...args),
                            running: () => null
                        },
                        debug: {
                            info: () => 'unknown',
                            traceback: () => new Error().stack
                        },
                        os: {
                            time: () => Math.floor(Date.now() / 1000),
                            date: (format, timestamp) => new Date(timestamp * 1000).toString(),
                            difftime: (t2, t1) => t2 - t1,
                            clock: () => performance.now() / 1000
                        }
                    };

                    // Pre-process code to handle Lua syntax
                    let processedCode = code
                        .replace(/--\[\[[\s\S]*?\]\]/g, '') // Multi-line comments
                        .replace(/--.*$/gm, '') // Single line comments
                        .replace(/\blocal\b/g, 'let')
                        .replace(/\bfunction\b/g, 'function')
                        .replace(/\bend\b/g, '}')
                        .replace(/\bthen\b/g, '{')
                        .replace(/\belseif\b/g, '} else if')
                        .replace(/\belse\b/g, '} else {')
                        .replace(/\bwhile\b/g, 'while')
                        .replace(/\bdo\b/g, '{')
                        .replace(/\bfor\b/g, 'for')
                        .replace(/\bin\b/g, 'in')
                        .replace(/\buntil\b/g, '} while(!')
                        .replace(/\brepeat\b/g, 'do {')
                        .replace(/\bnot\b/g, '!')
                        .replace(/\band\b/g, '&&')
                        .replace(/\bor\b/g, '||')
                        .replace(/\bnil\b/g, 'null')
                        .replace(/\.\.\./g, 'arguments')
                        .replace(/\[([^\]]+)\]/g, '.$1') // Array access to dot notation where possible
                        .replace(/~=/g, '!=')
                        .replace(/\.\./g, '+'); // String concatenation

                    // Wrap in async function
                    const wrappedCode = `(async () => { ${processedCode} })()`;

                    // Execute with context
                    const fn = new Function(...Object.keys(context), 'return ' + wrappedCode);
                    await fn(...Object.values(context));

                    this.log('info', '[Script] Execution completed successfully');
                } catch(err) {
                    this.log('error', '[Error] ' + err.message);
                    console.error(err);
                }

                this.running = false;
            },

            stop: function() {
                this.intervals.forEach(clearInterval);
                this.intervals = [];
                this.running = false;
                this.log('info', '[Script] Execution stopped');
            }
        };

        // ==================== ADMIN SYSTEM ====================
        const AdminSystem = {
            commands: {
                fly: {
                    description: 'Toggle fly mode',
                    args: ['player'],
                    execute: (target) => {
                        showToast(`${target} fly mode toggled`);
                        return true;
                    }
                },
                speed: {
                    description: 'Set walk speed',
                    args: ['player', 'value'],
                    execute: (target, value) => {
                        const speed = parseInt(value);
                        if (speed < 16 || speed > 200) return 'Speed must be 16-200';
                        showToast(`${target} speed set to ${speed}`);
                        return true;
                    }
                },
                jump: {
                    description: 'Set jump power',
                    args: ['player', 'value'],
                    execute: (target, value) => {
                        const power = parseInt(value);
                        if (power < 50 || power > 500) return 'Jump power must be 50-500';
                        showToast(`${target} jump power set to ${power}`);
                        return true;
                    }
                },
                god: {
                    description: 'Toggle god mode',
                    args: ['player'],
                    execute: (target) => {
                        showToast(`${target} god mode toggled`);
                        return true;
                    }
                },
                kill: {
                    description: 'Kill player',
                    args: ['player'],
                    execute: (target) => {
                        showToast(`Killed ${target}`);
                        return true;
                    }
                },
                respawn: {
                    description: 'Respawn player',
                    args: ['player'],
                    execute: (target) => {
                        showToast(`Respawned ${target}`);
                        return true;
                    }
                },
                kick: {
                    description: 'Kick player from server',
                    args: ['player', 'reason'],
                    execute: (target, reason = 'No reason given') => {
                        showToast(`Kicked ${target}: ${reason}`);
                        DataSystem.addModLog('kick', target, currentUser.username, reason);
                        return true;
                    }
                },
                ban: {
                    description: 'Ban player',
                    args: ['player', 'duration', 'reason'],
                    execute: (target, duration = '1d', reason = 'No reason given') => {
                        DataSystem.banUser(target, reason, duration, currentUser.username);
                        showToast(`Banned ${target} for ${duration}: ${reason}`);
                        return true;
                    }
                },
                teleport: {
                    description: 'Teleport player',
                    args: ['player', 'destination'],
                    execute: (target, dest) => {
                        showToast(`Teleported ${target} to ${dest}`);
                        return true;
                    }
                },
                give: {
                    description: 'Give item to player',
                    args: ['player', 'item'],
                    execute: (target, item) => {
                        showToast(`Gave ${item} to ${target}`);
                        return true;
                    }
                },
                time: {
                    description: 'Set time of day',
                    args: ['time'],
                    execute: (time) => {
                        const times = { day: '14:00:00', noon: '12:00:00', night: '00:00:00', morning: '06:00:00', evening: '18:00:00' };
                        const setTime = times[time] || time;
                        showToast(`Time set to ${setTime}`);
                        return true;
                    }
                },
                shutdown: {
                    description: 'Shutdown server',
                    args: ['message'],
                    execute: (msg = 'Server shutting down') => {
                        showToast(`Server shutdown: ${msg}`);
                        return true;
                    }
                },
                invisible: {
                    description: 'Toggle invisibility',
                    args: ['player'],
                    execute: (target) => {
                        showToast(`${target} visibility toggled`);
                        return true;
                    }
                },
                heal: {
                    description: 'Heal player',
                    args: ['player'],
                    execute: (target) => {
                        showToast(`Healed ${target}`);
                        return true;
                    }
                },
                explode: {
                    description: 'Explode player',
                    args: ['player'],
                    execute: (target) => {
                        showToast(`Exploded ${target}`);
                        return true;
                    }
                },
                freeze: {
                    description: 'Freeze player',
                    args: ['player'],
                    execute: (target) => {
                        showToast(`Froze ${target}`);
                        return true;
                    }
                },
                thaw: {
                    description: 'Unfreeze player',
                    args: ['player'],
                    execute: (target) => {
                        showToast(`Thawed ${target}`);
                        return true;
                    }
                },
                bring: {
                    description: 'Bring player to you',
                    args: ['player'],
                    execute: (target) => {
                        showToast(`Brought ${target}`);
                        return true;
                    }
                },
                to: {
                    description: 'Go to player',
                    args: ['player'],
                    execute: (target) => {
                        showToast(`Teleported to ${target}`);
                        return true;
                    }
                },
                nuke: {
                    description: 'Clear all blocks',
                    args: [],
                    execute: () => {
                        showToast('Nuked the world');
                        return true;
                    }
                },
                save: {
                    description: 'Save world',
                    args: [],
                    execute: () => {
                        showToast('World saved');
                        return true;
                    }
                },
                load: {
                    description: 'Load world',
                    args: ['name'],
                    execute: (name) => {
                        showToast(`Loaded world: ${name}`);
                        return true;
                    }
                }
            },

            parseCommand: function(input) {
                if (!input.startsWith(';')) return null;
                
                const parts = input.slice(1).trim().split(/\s+/);
                const cmdName = parts[0].toLowerCase();
                const args = parts.slice(1);
                
                const cmd = this.commands[cmdName];
                if (!cmd) return { error: `Unknown command: ${cmdName}` };
                
                if (args.length < cmd.args.filter(a => !a.includes('?')).length) {
                    return { error: `Usage: ;${cmdName} ${cmd.args.join(' ')}` };
                }
                
                return { command: cmd, args };
            },

            execute: function(input) {
                const parsed = this.parseCommand(input);
                if (parsed.error) {
                    showToast(parsed.error, 'error');
                    return false;
                }
                
                const result = parsed.command.execute(...parsed.args);
                if (typeof result === 'string') {
                    showToast(result, 'error');
                    return false;
                }
                
                // Log to moderation log
                this.addToLog(input);
                return true;
            },

            addToLog: function(command) {
                const log = document.getElementById('modLog');
                const entry = document.createElement('div');
                entry.className = 'flex items-center gap-2 p-2 rounded bg-white/5';
                const time = new Date().toLocaleTimeString();
                entry.innerHTML = `
                    <span class="text-white/30">[${time}]</span>
                    <span class="text-green-400 font-mono">${currentUser?.username || 'Admin'}</span>
                    <span class="text-white/50">ran</span>
                    <code class="text-yellow-400">${command}</code>
                `;
                log.insertBefore(entry, log.firstChild);
            }
        };

        // ==================== SHOP SYSTEM ====================
        const ShopSystem = {
            init() {
                this.renderCoinsShop();
                this.renderRobuxShop();
            },

            renderCoinsShop() {
                const data = DataSystem.getData();
                const items = data.shop.items;

                // Clothing
                const clothingEl = document.getElementById('clothingItems');
                clothingEl.innerHTML = items.clothing.filter(i => i.currency === 'coins').map(item => `
                    <div class="shop-item glass rounded-xl p-4 border border-white/10">
                        <div class="text-4xl mb-2 text-center">${item.icon}</div>
                        <h4 class="font-bold text-sm text-center mb-1">${item.name}</h4>
                        <div class="flex items-center justify-center gap-1 text-yellow-400 font-bold mb-3">
                            <i class="fas fa-coins text-xs"></i> ${item.price}
                        </div>
                        <button onclick="buyItem('${item.id}')" class="w-full py-2 rounded-lg bg-yellow-500/20 text-yellow-300 text-sm font-bold btn-press">
                            Buy
                        </button>
                    </div>
                `).join('');

                // Accessories
                const accessoryEl = document.getElementById('accessoryItems');
                accessoryEl.innerHTML = items.accessories.filter(i => i.currency === 'coins').map(item => `
                    <div class="shop-item glass rounded-xl p-4 border border-white/10 relative overflow-hidden">
                        ${item.rarity === 'legendary' ? '<div class="absolute top-0 right-0 bg-yellow-500 text-xs px-2 py-0.5 rounded-bl-lg">LEGENDARY</div>' : ''}
                        <div class="text-4xl mb-2 text-center">${item.icon}</div>
                        <h4 class="font-bold text-sm text-center mb-1">${item.name}</h4>
                        <div class="flex items-center justify-center gap-1 text-yellow-400 font-bold mb-3">
                            <i class="fas fa-coins text-xs"></i> ${item.price}
                        </div>
                        <button onclick="buyItem('${item.id}')" class="w-full py-2 rounded-lg bg-yellow-500/20 text-yellow-300 text-sm font-bold btn-press">
                            Buy
                        </button>
                    </div>
                `).join('');

                // Power-ups
                const powerupEl = document.getElementById('powerupItems');
                powerupEl.innerHTML = items.powerups.map(item => `
                    <div class="shop-item glass rounded-xl p-4 border border-white/10">
                        <div class="text-4xl mb-2 text-center">${item.icon}</div>
                        <h4 class="font-bold text-sm text-center mb-1">${item.name}</h4>
                        <p class="text-[10px] text-white/50 text-center mb-2">${item.duration}s duration</p>
                        <div class="flex items-center justify-center gap-1 text-yellow-400 font-bold mb-3">
                            <i class="fas fa-coins text-xs"></i> ${item.price}
                        </div>
                        <button onclick="buyItem('${item.id}')" class="w-full py-2 rounded-lg bg-yellow-500/20 text-yellow-300 text-sm font-bold btn-press">
                            Buy
                        </button>
                    </div>
                `).join('');
            },

            renderRobuxShop() {
                const data = DataSystem.getData();
                const items = data.shop.items;

                // Gamepasses
                const gamepassEl = document.getElementById('gamepassItems');
                gamepassEl.innerHTML = items.gamepasses.map(item => `
                    <div class="shop-item glass rounded-xl p-4 border border-purple-500/30 bg-purple-500/5">
                        <div class="flex items-start gap-3">
                            <div class="text-4xl">${item.icon}</div>
                            <div class="flex-1">
                                <h4 class="font-bold mb-1">${item.name}</h4>
                                <p class="text-xs text-white/60 mb-2">${item.description}</p>
                                <div class="flex flex-wrap gap-1 mb-3">
                                    ${item.benefits.map(b => `<span class="text-[10px] bg-purple-500/20 px-2 py-0.5 rounded-full text-purple-300">${b}</span>`).join('')}
                                </div>
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-1 text-purple-400 font-bold">
                                        <i class="fas fa-gem text-xs"></i> ${item.price}
                                    </div>
                                    <button onclick="buyRobuxItem('${item.id}')" class="px-4 py-1.5 rounded-lg bg-purple-500/20 text-purple-300 text-sm font-bold btn-press">
                                        Buy
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');

                // Dev Products
                const devProductEl = document.getElementById('devProductItems');
                devProductEl.innerHTML = items.devproducts.map(item => `
                    <div class="shop-item glass rounded-xl p-4 border border-white/10 text-center">
                        <div class="text-3xl mb-2">${item.icon}</div>
                        <h4 class="font-bold text-sm mb-1">${item.name}</h4>
                        <div class="flex items-center justify-center gap-1 text-purple-400 font-bold mb-3">
                            <i class="fas fa-gem text-xs"></i> ${item.price}
                        </div>
                        <button onclick="buyRobuxItem('${item.id}')" class="w-full py-2 rounded-lg bg-purple-500/20 text-purple-300 text-sm font-bold btn-press">
                            Buy
                        </button>
                    </div>
                `).join('');
            }
        };

        // ==================== APP STATE ====================
        let currentUser = null;
        let currentTool = 'select';
        let isAdmin = false;
        let studioScene, studioCamera, studioRenderer;

        // ==================== INITIALIZATION ====================
        window.onload = () => {
            DataSystem.init();
            
            // Simulate loading
            let progress = 0;
            const loadInterval = setInterval(() => {
                progress += Math.random() * 20;
                if (progress >= 100) {
                    progress = 100;
                    clearInterval(loadInterval);
                    setTimeout(() => {
                        document.getElementById('loadingScreen').classList.add('hidden');
                        checkSession();
                    }, 500);
                }
                document.getElementById('loadingBar').style.width = progress + '%';
            }, 200);
        };

        function checkSession() {
            const saved = localStorage.getItem('blockverse_session');
            if (saved) {
                try {
                    const session = JSON.parse(saved);
                    const account = DataSystem.getAccount(session.username);
                    if (account && account.password === session.passwordHash) {
                        loginUser(account);
                        return;
                    }
                } catch(e) {}
            }
            document.getElementById('authContainer').classList.remove('hidden');
        }

        function loginUser(account) {
            currentUser = account;
            isAdmin = account.isAdmin || account.isOwner;
            
            // Update UI
            document.getElementById('authContainer').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            
            // Show admin elements if applicable
            if (isAdmin) {
                document.getElementById('adminMenuBtn').classList.remove('hidden');
                document.getElementById('adminIndicator').classList.remove('hidden');
                document.getElementById('inGameAdminBtn').classList.remove('hidden');
                document.getElementById('menuRole').textContent = account.isOwner ? 'Game Owner' : 'Moderator';
            }
            
            updateProfileUI();
            ShopSystem.init();
            generateGames();
            initStudio();
            
            showSection('play');
            showToast(`Welcome back, ${account.username}!`);
        }

        function updateProfileUI() {
            if (!currentUser) return;
            
            document.getElementById('coinDisplay').textContent = currentUser.coins.toLocaleString();
            document.getElementById('robuxAmount').textContent = currentUser.robux.toLocaleString();
            document.getElementById('robuxDisplay').style.display = 'flex';
            document.getElementById('menuUsername').textContent = currentUser.username;
            document.getElementById('profileUsername').textContent = currentUser.username;
            document.getElementById('profileCoins').textContent = currentUser.coins.toLocaleString();
            document.getElementById('profileRobux').textContent = currentUser.robux.toLocaleString();
            document.getElementById('headerAvatar').style.backgroundColor = currentUser.avatarColor || '#4ECDC4';
        }

        // ==================== AUTH HANDLERS ====================
        function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            const account = DataSystem.getAccount(username);
            if (!account || account.password !== DataSystem.hashPassword(password)) {
                showToast('Invalid username or password', 'error');
                return;
            }
            
            // Save session
            localStorage.setItem('blockverse_session', JSON.stringify({
                username: account.username,
                passwordHash: account.password
            }));
            
            loginUser(account);
        }

        function handleRegister(e) {
            e.preventDefault();
            const username = document.getElementById('regUsername').value;
            const password = document.getElementById('regPassword').value;
            const confirm = document.getElementById('regConfirmPassword').value;
            
            if (password !== confirm) {
                showToast('Passwords do not match', 'error');
                return;
            }
            
            if (DataSystem.getAccount(username)) {
                showToast('Username already exists', 'error');
                return;
            }
            
            const account = DataSystem.createAccount(username, {
                fullName: document.getElementById('regName').value,
                username: username,
                birthday: document.getElementById('regBirthday').value,
                password: DataSystem.hashPassword(password),
                avatarColor: '#4ECDC4'
            });
            
            // Auto login
            localStorage.setItem('blockverse_session', JSON.stringify({
                username: account.username,
                passwordHash: account.password
            }));
            
            loginUser(account);
            showToast('Account created successfully!');
        }

        function showLogin() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
        }

        function showRegister() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
        }

        function logout() {
            localStorage.removeItem('blockverse_session');
            location.reload();
        }

        // ==================== UI FUNCTIONS ====================
        function showSection(section) {
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            document.getElementById(section + 'Section')?.classList.remove('hidden');
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active', 'opacity-100');
                btn.classList.add('opacity-60');
                if (btn.dataset.section === section) {
                    btn.classList.add('active', 'opacity-100');
                    btn.classList.remove('opacity-60');
                }
            });
            
            document.getElementById('profileMenu').classList.add('hidden');
            
            if (section === 'admin') {
                updateAdminPanel();
            }
        }

        function toggleProfileMenu() {
            document.getElementById('profileMenu').classList.toggle('hidden');
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show';
            
            if (type === 'error') toast.style.background = 'rgba(239, 68, 68, 0.9)';
            else if (type === 'success') toast.style.background = 'rgba(34, 197, 94, 0.9)';
            else toast.style.background = 'rgba(0, 0, 0, 0.9)';
            
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // ==================== STUDIO FUNCTIONS ====================
        function initStudio() {
            const canvas = document.getElementById('studioCanvas');
            studioScene = new THREE.Scene();
            studioScene.background = new THREE.Color(0x1a1a2e);
            
            studioCamera = new THREE.PerspectiveCamera(75, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
            studioCamera.position.set(10, 10, 10);
            studioCamera.lookAt(0, 0, 0);
            
            studioRenderer = new THREE.WebGLRenderer({ canvas, antialias: true });
            studioRenderer.setSize(canvas.clientWidth, canvas.clientHeight);
            studioRenderer.shadowMap.enabled = true;
            
            // Grid
            const gridHelper = new THREE.GridHelper(100, 100, 0x444444, 0x222222);
            studioScene.add(gridHelper);
            
            // Lighting
            const ambient = new THREE.AmbientLight(0xffffff, 0.4);
            studioScene.add(ambient);
            
            const dir = new THREE.DirectionalLight(0xffffff, 0.8);
            dir.position.set(10, 20, 10);
            studioScene.add(dir);
            
            // Baseplate
            const baseplate = new THREE.Mesh(
                new THREE.BoxGeometry(50, 1, 50),
                new THREE.MeshLambertMaterial({ color: 0x2ecc71 })
            );
            baseplate.position.y = -0.5;
            baseplate.receiveShadow = true;
            studioScene.add(baseplate);
            
            animateStudio();
        }

        function animateStudio() {
            requestAnimationFrame(animateStudio);
            studioRenderer.render(studioScene, studioCamera);
        }

        function selectTool(tool) {
            currentTool = tool;
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }

        function toggleScriptEditor() {
            document.getElementById('scriptEditor').classList.toggle('hidden');
        }

        function updateCodeHighlight() {
            const textarea = document.getElementById('codeInput');
            const highlight = document.getElementById('codeHighlight');
            
            let code = textarea.value
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
            
            // Simple syntax highlighting
            code = code
                .replace(/(\b(function|local|if|then|else|elseif|end|while|do|for|in|return|and|or|not|true|false|nil)\b)/g, '<span class="syntax-keyword">$1</span>')
                .replace(/(".*?"|'.*?')/g, '<span class="syntax-string">$1</span>')
                .replace(/\b(\d+)\b/g, '<span class="syntax-number">$1</span>')
                .replace(/(--.*$)/gm, '<span class="syntax-comment">$1</span>');
            
            highlight.innerHTML = code;
        }

        function syncScroll() {
            const textarea = document.getElementById('codeInput');
            const highlight = document.getElementById('codeHighlight');
            highlight.scrollTop = textarea.scrollTop;
            highlight.scrollLeft = textarea.scrollLeft;
        }

        function runScript() {
            const code = document.getElementById('codeInput').value;
            ScriptEngine.execute(code);
 'Heal player',
                    args: ['player'],
                    execute: (target) => {
                        showToast(`Healed ${target}`);
                        return true;
                    }
                },
                explode: {
                    description: 'Explode player',
                    args: ['player'],
                    execute: (target) => {
                        showToast(`Exploded ${target}`);
                        return true;
                    }
                },
                freeze: {
                    description: 'Freeze player',
                    args: ['player'],
                    execute: (target) => {
                        showToast(`Froze ${target}`);
                        return true;
                    }
                },
                thaw: {
                    description: 'Unfreeze player',
                    args: ['player'],
                    execute: (target) => {
                        showToast(`Thawed ${target}`);
                        return true;
                    }
                },
                bring: {
                    description: 'Bring player to you',
                    args: ['player'],
                    execute: (target) => {
                        showToast(`Brought ${target}`);
                        return true;
                    }
                },
                to: {
                    description: 'Go to player',
                    args: ['player'],
                    execute: (target) => {
                        showToast(`Teleported to ${target}`);
                        return true;
                    }
                },
                nuke: {
                    description: 'Clear all blocks',
                    args: [],
                    execute: () => {
                        showToast('Nuked the world');
                        return true;
                    }
                },
                save: {
                    description: 'Save world',
                    args: [],
                    execute: () => {
                        showToast('World saved');
                        return true;
                    }
                },
                load: {
                    description: 'Load world',
                    args: ['name'],
                    execute: (name) => {
                        showToast(`Loaded world: ${name}`);
                        return true;
                    }
                }
            },

            parseCommand: function(input) {
                if (!input.startsWith(';')) return null;
                
                const parts = input.slice(1).trim().split(/\s+/);
                const cmdName = parts[0].toLowerCase();
                const args = parts.slice(1);
                
                const cmd = this.commands[cmdName];
                if (!cmd) return { error: `Unknown command: ${cmdName}` };
                
                if (args.length < cmd.args.filter(a => !a.includes('?')).length) {
                    return { error: `Usage: ;${cmdName} ${cmd.args.join(' ')}` };
                }
                
                return { command: cmd, args };
            },

            execute: function(input) {
                const parsed = this.parseCommand(input);
                if (parsed.error) {
                    showToast(parsed.error, 'error');
                    return false;
                }
                
                const result = parsed.command.execute(...parsed.args);
                if (typeof result === 'string') {
                    showToast(result, 'error');
                    return false;
                }
                
                // Log to moderation log
                this.addToLog(input);
                return true;
            },

            addToLog: function(command) {
                const log = document.getElementById('modLog');
                const entry = document.createElement('div');
                entry.className = 'flex items-center gap-2 p-2 rounded bg-white/5';
                const time = new Date().toLocaleTimeString();
                entry.innerHTML = `
                    <span class="text-white/30">[${time}]</span>
                    <span class="text-green-400 font-mono">${currentUser?.username || 'Admin'}</span>
                    <span class="text-white/50">ran</span>
                    <code class="text-yellow-400">${command}</code>
                `;
                log.insertBefore(entry, log.firstChild);
            }
        };

        // ==================== SHOP SYSTEM ====================
        const ShopSystem = {
            init() {
                this.renderCoinsShop();
                this.renderRobuxShop();
            },

            renderCoinsShop() {
                const data = DataSystem.getData();
                const items = data.shop.items;

                // Clothing
                const clothingEl = document.getElementById('clothingItems');
                clothingEl.innerHTML = items.clothing.filter(i => i.currency === 'coins').map(item => `
                    <div class="shop-item glass rounded-xl p-4 border border-white/10">
                        <div class="text-4xl mb-2 text-center">${item.icon}</div>
                        <h4 class="font-bold text-sm text-center mb-1">${item.name}</h4>
                        <div class="flex items-center justify-center gap-1 text-yellow-400 font-bold mb-3">
                            <i class="fas fa-coins text-xs"></i> ${item.price}
                        </div>
                        <button onclick="buyItem('${item.id}')" class="w-full py-2 rounded-lg bg-yellow-500/20 text-yellow-300 text-sm font-bold btn-press">
                            Buy
                        </button>
                    </div>
                `).join('');

                // Accessories
                const accessoryEl = document.getElementById('accessoryItems');
                accessoryEl.innerHTML = items.accessories.filter(i => i.currency === 'coins').map(item => `
                    <div class="shop-item glass rounded-xl p-4 border border-white/10 relative overflow-hidden">
                        ${item.rarity === 'legendary' ? '<div class="absolute top-0 right-0 bg-yellow-500 text-xs px-2 py-0.5 rounded-bl-lg">LEGENDARY</div>' : ''}
                        <div class="text-4xl mb-2 text-center">${item.icon}</div>
                        <h4 class="font-bold text-sm text-center mb-1">${item.name}</h4>
                        <div class="flex items-center justify-center gap-1 text-yellow-400 font-bold mb-3">
                            <i class="fas fa-coins text-xs"></i> ${item.price}
                        </div>
                        <button onclick="buyItem('${item.id}')" class="w-full py-2 rounded-lg bg-yellow-500/20 text-yellow-300 text-sm font-bold btn-press">
                            Buy
                        </button>
                    </div>
                `).join('');

                // Power-ups
                const powerupEl = document.getElementById('powerupItems');
                powerupEl.innerHTML = items.powerups.map(item => `
                    <div class="shop-item glass rounded-xl p-4 border border-white/10">
                        <div class="text-4xl mb-2 text-center">${item.icon}</div>
                        <h4 class="font-bold text-sm text-center mb-1">${item.name}</h4>
                        <p class="text-[10px] text-white/50 text-center mb-2">${item.duration}s duration</p>
                        <div class="flex items-center justify-center gap-1 text-yellow-400 font-bold mb-3">
                            <i class="fas fa-coins text-xs"></i> ${item.price}
                        </div>
                        <button onclick="buyItem('${item.id}')" class="w-full py-2 rounded-lg bg-yellow-500/20 text-yellow-300 text-sm font-bold btn-press">
                            Buy
                        </button>
                    </div>
                `).join('');
            },

            renderRobuxShop() {
                const data = DataSystem.getData();
                const items = data.shop.items;

                // Gamepasses
                const gamepassEl = document.getElementById('gamepassItems');
                gamepassEl.innerHTML = items.gamepasses.map(item => `
                    <div class="shop-item glass rounded-xl p-4 border border-purple-500/30 bg-purple-500/5">
                        <div class="flex items-start gap-3">
                            <div class="text-4xl">${item.icon}</div>
                            <div class="flex-1">
                                <h4 class="font-bold mb-1">${item.name}</h4>
                                <p class="text-xs text-white/60 mb-2">${item.description}</p>
                                <div class="flex flex-wrap gap-1 mb-3">
                                    ${item.benefits.map(b => `<span class="text-[10px] bg-purple-500/20 px-2 py-0.5 rounded-full text-purple-300">${b}</span>`).join('')}
                                </div>
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-1 text-purple-400 font-bold">
                                        <i class="fas fa-gem text-xs"></i> ${item.price}
                                    </div>
                                    <button onclick="buyRobuxItem('${item.id}')" class="px-4 py-1.5 rounded-lg bg-purple-500/20 text-purple-300 text-sm font-bold btn-press">
                                        Buy
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');

                // Dev Products
                const devProductEl = document.getElementById('devProductItems');
                devProductEl.innerHTML = items.devproducts.map(item => `
                    <div class="shop-item glass rounded-xl p-4 border border-white/10 text-center">
                        <div class="text-3xl mb-2">${item.icon}</div>
                        <h4 class="font-bold text-sm mb-1">${item.name}</h4>
                        <div class="flex items-center justify-center gap-1 text-purple-400 font-bold mb-3">
                            <i class="fas fa-gem text-xs"></i> ${item.price}
                        </div>
                        <button onclick="buyRobuxItem('${item.id}')" class="w-full py-2 rounded-lg bg-purple-500/20 text-purple-300 text-sm font-bold btn-press">
                            Buy
                        </button>
                    </div>
                `).join('');
            }
        };

        // ==================== APP STATE ====================
        let currentUser = null;
        let currentTool = 'select';
        let isAdmin = false;
        let studioScene, studioCamera, studioRenderer;

        // ==================== INITIALIZATION ====================
        window.onload = () => {
            DataSystem.init();
            
            // Simulate loading
            let progress = 0;
            const loadInterval = setInterval(() => {
                progress += Math.random() * 20;
                if (progress >= 100) {
                    progress = 100;
                    clearInterval(loadInterval);
                    setTimeout(() => {
                        document.getElementById('loadingScreen').classList.add('hidden');
                        checkSession();
                    }, 500);
                }
                document.getElementById('loadingBar').style.width = progress + '%';
            }, 200);
        };

        function checkSession() {
            const saved = localStorage.getItem('blockverse_session');
            if (saved) {
                try {
                    const session = JSON.parse(saved);
                    const account = DataSystem.getAccount(session.username);
                    if (account && account.password === session.passwordHash) {
                        loginUser(account);
                        return;
                    }
                } catch(e) {}
            }
            document.getElementById('authContainer').classList.remove('hidden');
        }

        function loginUser(account) {
            currentUser = account;
            isAdmin = account.isAdmin || account.isOwner;
            
            // Update UI
            document.getElementById('authContainer').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            
            // Show admin elements if applicable
            if (isAdmin) {
                document.getElementById('adminMenuBtn').classList.remove('hidden');
                document.getElementById('adminIndicator').classList.remove('hidden');
                document.getElementById('inGameAdminBtn').classList.remove('hidden');
                document.getElementById('menuRole').textContent = account.isOwner ? 'Game Owner' : 'Moderator';
            }
            
            updateProfileUI();
            ShopSystem.init();
            generateGames();
            initStudio();
            
            showSection('play');
            showToast(`Welcome back, ${account.username}!`);
        }

        function updateProfileUI() {
            if (!currentUser) return;
            
            document.getElementById('coinDisplay').textContent = currentUser.coins.toLocaleString();
            document.getElementById('robuxAmount').textContent = currentUser.robux.toLocaleString();
            document.getElementById('robuxDisplay').style.display = 'flex';
            document.getElementById('menuUsername').textContent = currentUser.username;
            document.getElementById('profileUsername').textContent = currentUser.username;
            document.getElementById('profileCoins').textContent = currentUser.coins.toLocaleString();
            document.getElementById('profileRobux').textContent = currentUser.robux.toLocaleString();
            document.getElementById('headerAvatar').style.backgroundColor = currentUser.avatarColor || '#4ECDC4';
        }

        // ==================== AUTH HANDLERS ====================
        function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            const account = DataSystem.getAccount(username);
            if (!account || account.password !== DataSystem.hashPassword(password)) {
                showToast('Invalid username or password', 'error');
                return;
            }
            
            // Save session
            localStorage.setItem('blockverse_session', JSON.stringify({
                username: account.username,
                passwordHash: account.password
            }));
            
            loginUser(account);
        }

        function handleRegister(e) {
            e.preventDefault();
            const username = document.getElementById('regUsername').value;
            const password = document.getElementById('regPassword').value;
            const confirm = document.getElementById('regConfirmPassword').value;
            
            if (password !== confirm) {
                showToast('Passwords do not match', 'error');
                return;
            }
            
            if (DataSystem.getAccount(username)) {
                showToast('Username already exists', 'error');
                return;
            }
            
            const account = DataSystem.createAccount(username, {
                fullName: document.getElementById('regName').value,
                username: username,
                birthday: document.getElementById('regBirthday').value,
                password: DataSystem.hashPassword(password),
                avatarColor: '#4ECDC4'
            });
            
            // Auto login
            localStorage.setItem('blockverse_session', JSON.stringify({
                username: account.username,
                passwordHash: account.password
            }));
            
            loginUser(account);
            showToast('Account created successfully!');
        }

        function showLogin() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
        }

        function showRegister() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
        }

        function logout() {
            localStorage.removeItem('blockverse_session');
            location.reload();
        }

        // ==================== UI FUNCTIONS ====================
        function showSection(section) {
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            document.getElementById(section + 'Section')?.classList.remove('hidden');
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active', 'opacity-100');
                btn.classList.add('opacity-60');
                if (btn.dataset.section === section) {
                    btn.classList.add('active', 'opacity-100');
                    btn.classList.remove('opacity-60');
                }
            });
            
            document.getElementById('profileMenu').classList.add('hidden');
            
            if (section === 'admin') {
                updateAdminPanel();
            }
        }

        function toggleProfileMenu() {
            document.getElementById('profileMenu').classList.toggle('hidden');
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show';
            
            if (type === 'error') toast.style.background = 'rgba(239, 68, 68, 0.9)';
            else if (type === 'success') toast.style.background = 'rgba(34, 197, 94, 0.9)';
            else toast.style.background = 'rgba(0, 0, 0, 0.9)';
            
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // ==================== STUDIO FUNCTIONS ====================
        function initStudio() {
            const canvas = document.getElementById('studioCanvas');
            studioScene = new THREE.Scene();
            studioScene.background = new THREE.Color(0x1a1a2e);
            
            studioCamera = new THREE.PerspectiveCamera(75, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
            studioCamera.position.set(10, 10, 10);
            studioCamera.lookAt(0, 0, 0);
            
            studioRenderer = new THREE.WebGLRenderer({ canvas, antialias: true });
            studioRenderer.setSize(canvas.clientWidth, canvas.clientHeight);
            studioRenderer.shadowMap.enabled = true;
            
            // Grid
            const gridHelper = new THREE.GridHelper(100, 100, 0x444444, 0x222222);
            studioScene.add(gridHelper);
            
            // Lighting
            const ambient = new THREE.AmbientLight(0xffffff, 0.4);
            studioScene.add(ambient);
            
            const dir = new THREE.DirectionalLight(0xffffff, 0.8);
            dir.position.set(10, 20, 10);
            studioScene.add(dir);
            
            // Baseplate
            const baseplate = new THREE.Mesh(
                new THREE.BoxGeometry(50, 1, 50),
                new THREE.MeshLambertMaterial({ color: 0x2ecc71 })
            );
            baseplate.position.y = -0.5;
            baseplate.receiveShadow = true;
            studioScene.add(baseplate);
            
            animateStudio();
        }

        function animateStudio() {
            requestAnimationFrame(animateStudio);
            studioRenderer.render(studioScene, studioCamera);
        }

        function selectTool(tool) {
            currentTool = tool;
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }

        function toggleScriptEditor() {
            document.getElementById('scriptEditor').classList.toggle('hidden');
        }

        function updateCodeHighlight() {
            const textarea = document.getElementById('codeInput');
            const highlight = document.getElementById('codeHighlight');
            
            let code = textarea.value
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
            
            // Simple syntax highlighting
            code = code
                .replace(/(\b(function|local|if|then|else|elseif|end|while|do|for|in|return|and|or|not|true|false|nil)\b)/g, '<span class="syntax-keyword">$1</span>')
                .replace(/(".*?"|'.*?')/g, '<span class="syntax-string">$1</span>')
                .replace(/\b(\d+)\b/g, '<span class="syntax-number">$1</span>')
                .replace(/(--.*$)/gm, '<span class="syntax-comment">$1</span>');
            
            highlight.innerHTML = code;
        }

        function syncScroll() {
            const textarea = document.getElementById('codeInput');
            const highlight = document.getElementById('codeHighlight');
            highlight.scrollTop = textarea.scrollTop;
            highlight.scrollLeft = textarea.scrollLeft;
        }

        function runScript() {
            const code = document.getElementById('codeInput').value;
            ScriptEngine.execute(code);
        }

        function stopScript() {
            ScriptEngine.stop();
        }

        function clearConsole() {
            ScriptEngine.clear();
        }

        function selectScript(name) {
            toggleScriptEditor();
        }

        // ==================== SHOP FUNCTIONS ====================
        function showShopTab(tab) {
            document.getElementById('coinsShop').classList.add('hidden');
            document.getElementById('robuxShop').classList.add('hidden');
            document.getElementById('coinsTab').classList.remove('bg-yellow-500/20', 'text-yellow-300', 'border-yellow-500/50');
            document.getElementById('coinsTab').classList.add('glass');
            document.getElementById('robuxTab').classList.remove('bg-purple-500/20', 'text-purple-300', 'border-purple-500/50');
            document.getElementById('robuxTab').classList.add('glass');
            
            if (tab === 'coins') {
                document.getElementById('coinsShop').classList.remove('hidden');
                document.getElementById('coinsTab').classList.add('bg-yellow-500/20', 'text-yellow-300', 'border-yellow-500/50');
                document.getElementById('coinsTab').classList.remove('glass');
            } else {
                document.getElementById('robuxShop').classList.remove('hidden');
                document.getElementById('robuxTab').classList.add('bg-purple-500/20', 'text-purple-300', 'border-purple-500/50');
                document.getElementById('robuxTab').classList.remove('glass');
            }
        }

        function buyItem(itemId) {
            const data = DataSystem.getData();
            const allItems = [...data.shop.items.clothing, ...data.shop.items.accessories, ...data.shop.items.powerups];
            const item = allItems.find(i => i.id === itemId);
            
            if (!item) return;
            
            if (currentUser.coins < item.price) {
                showToast('Not enough coins!', 'error');
                return;
            }
            
            currentUser.coins -= item.price;
            currentUser.inventory.push(item);
            DataSystem.updateAccount(currentUser.username, {
                coins: currentUser.coins,
                inventory: currentUser.inventory
            });
            
            DataSystem.addPurchase(currentUser.username, item);
            updateProfileUI();
            showToast(`Purchased ${item.name}!`, 'success');
        }

        function buyRobuxItem(itemId) {
            const data = DataSystem.getData();
            const allItems = [...data.shop.items.gamepasses, ...data.shop.items.devproducts];
            const item = allItems.find(i => i.id === itemId);
            
            if (!item) return;
            
            if (currentUser.robux < item.price) {
                showToast('Not enough Robux!', 'error');
                return;
            }
            
            currentUser.robux -= item.price;
            
            if (item.reward) {
                if (item.reward.coins) currentUser.coins += item.reward.coins;
            }
            
            if (item.benefits) {
                currentUser.gamepasses.push(item);
            }
            
            DataSystem.updateAccount(currentUser.username, {
                robux: currentUser.robux,
                coins: currentUser.coins,
                gamepasses: currentUser.gamepasses
            });
            
            updateProfileUI();
            showToast(`Purchased ${item.name}!`, 'success');
        }

        function buyRobux(amount) {
            // Simulate purchase
            setTimeout(() => {
                currentUser.robux += amount;
                DataSystem.updateAccount(currentUser.username, { robux: currentUser.robux });
                updateProfileUI();
                showToast(`Added ${amount} Robux!`, 'success');
            }, 1000);
        }

        // ==================== ADMIN FUNCTIONS ====================
        function updateAdminPanel() {
            // Update player list
            const list = document.getElementById('adminPlayerList');
            const mockPlayers = [
                { name: currentUser.username, id: 1, isAdmin: true },
                { name: 'Player2', id: 2, isAdmin: false },
                { name: 'BuilderPro', id: 3, isAdmin: false }
            ];
            
            list.innerHTML = mockPlayers.map(p => `
                <div class="flex items-center justify-between p-2 rounded-lg bg-white/5 hover:bg-white/10 cursor-pointer" onclick="selectPlayer('${p.name}')">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-400 to-purple-500 flex items-center justify-center text-xs font-bold">
                            ${p.name[0]}
                        </div>
                        <div>
                            <div class="font-bold text-sm ${p.isAdmin ? 'text-red-300' : ''}">${p.name} ${p.isAdmin ? '(Admin)' : ''}</div>
                            <div class="text-[10px] text-white/50">ID: ${p.id}</div>
                        </div>
                    </div>
                    <input type="checkbox" class="player-select w-4 h-4 rounded border-white/30 bg-white/10" data-player="${p.name}">
                </div>
            `).join('');
            
            document.getElementById('adminPlayerCount').textContent = mockPlayers.length;
        }

        function selectPlayer(name) {
            // Toggle checkbox
            const checkbox = document.querySelector(`[data-player="${name}"]`);
            if (checkbox) checkbox.checked = !checkbox.checked;
        }

        function adminAction(action) {
            const selected = Array.from(document.querySelectorAll('.player-select:checked')).map(cb => cb.dataset.player);
            
            if (selected.length === 0) {
                showToast('Select a player first', 'error');
                return 'Heal player',
                    args: ['player'],
                    execute: (target) => {
                        showToast(`Healed ${target}`);
                        return true;
                    }
                },
                explode: {
                    description: 'Explode player',
                    args: ['player'],
                    execute: (target) => {
                        showToast(`Exploded ${target}`);
                        return true;
                    }
                },
                freeze: {
                    description: 'Freeze player',
                    args: ['player'],
                    execute: (target) => {
                        showToast(`Froze ${target}`);
                        return true;
                    }
                },
                thaw: {
                    description: 'Unfreeze player',
                    args: ['player'],
                    execute: (target) => {
                        showToast(`Thawed ${target}`);
                        return true;
                    }
                },
                bring: {
                    description: 'Bring player to you',
                    args: ['player'],
                    execute: (target) => {
                        showToast(`Brought ${target}`);
                        return true;
                    }
                },
                to: {
                    description: 'Go to player',
                    args: ['player'],
                    execute: (target) => {
                        showToast(`Teleported to ${target}`);
                        return true;
                    }
                },
                nuke: {
                    description: 'Clear all blocks',
                    args: [],
                    execute: () => {
                        showToast('Nuked the world');
                        return true;
                    }
                },
                save: {
                    description: 'Save world',
                    args: [],
                    execute: () => {
                        showToast('World saved');
                        return true;
                    }
                },
                load: {
                    description: 'Load world',
                    args: ['name'],
                    execute: (name) => {
                        showToast(`Loaded world: ${name}`);
                        return true;
                    }
                }
            },

            parseCommand: function(input) {
                if (!input.startsWith(';')) return null;
                
                const parts = input.slice(1).trim().split(/\s+/);
                const cmdName = parts[0].toLowerCase();
                const args = parts.slice(1);
                
                const cmd = this.commands[cmdName];
                if (!cmd) return { error: `Unknown command: ${cmdName}` };
                
                if (args.length < cmd.args.filter(a => !a.includes('?')).length) {
                    return { error: `Usage: ;${cmdName} ${cmd.args.join(' ')}` };
                }
                
                return { command: cmd, args };
            },

            execute: function(input) {
                const parsed = this.parseCommand(input);
                if (parsed.error) {
                    showToast(parsed.error, 'error');
                    return false;
                }
                
                const result = parsed.command.execute(...parsed.args);
                if (typeof result === 'string') {
                    showToast(result, 'error');
                    return false;
                }
                
                // Log to moderation log
                this.addToLog(input);
                return true;
            },

            addToLog: function(command) {
                const log = document.getElementById('modLog');
                const entry = document.createElement('div');
                entry.className = 'flex items-center gap-2 p-2 rounded bg-white/5';
                const time = new Date().toLocaleTimeString();
                entry.innerHTML = `
                    <span class="text-white/30">[${time}]</span>
                    <span class="text-green-400 font-mono">${currentUser?.username || 'Admin'}</span>
                    <span class="text-white/50">ran</span>
                    <code class="text-yellow-400">${command}</code>
                `;
                log.insertBefore(entry, log.firstChild);
            }
        };

        // ==================== SHOP SYSTEM ====================
        const ShopSystem = {
            init() {
                this.renderCoinsShop();
                this.renderRobuxShop();
            },

            renderCoinsShop() {
                const data = DataSystem.getData();
                const items = data.shop.items;

                // Clothing
                const clothingEl = document.getElementById('clothingItems');
                clothingEl.innerHTML = items.clothing.filter(i => i.currency === 'coins').map(item => `
                    <div class="shop-item glass rounded-xl p-4 border border-white/10">
                        <div class="text-4xl mb-2 text-center">${item.icon}</div>
                        <h4 class="font-bold text-sm text-center mb-1">${item.name}</h4>
                        <div class="flex items-center justify-center gap-1 text-yellow-400 font-bold mb-3">
                            <i class="fas fa-coins text-xs"></i> ${item.price}
                        </div>
                        <button onclick="buyItem('${item.id}')" class="w-full py-2 rounded-lg bg-yellow-500/20 text-yellow-300 text-sm font-bold btn-press">
                            Buy
                        </button>
                    </div>
                `).join('');

                // Accessories
                const accessoryEl = document.getElementById('accessoryItems');
                accessoryEl.innerHTML = items.accessories.filter(i => i.currency === 'coins').map(item => `
                    <div class="shop-item glass rounded-xl p-4 border border-white/10 relative overflow-hidden">
                        ${item.rarity === 'legendary' ? '<div class="absolute top-0 right-0 bg-yellow-500 text-xs px-2 py-0.5 rounded-bl-lg">LEGENDARY</div>' : ''}
                        <div class="text-4xl mb-2 text-center">${item.icon}</div>
                        <h4 class="font-bold text-sm text-center mb-1">${item.name}</h4>
                        <div class="flex items-center justify-center gap-1 text-yellow-400 font-bold mb-3">
                            <i class="fas fa-coins text-xs"></i> ${item.price}
                        </div>
                        <button onclick="buyItem('${item.id}')" class="w-full py-2 rounded-lg bg-yellow-500/20 text-yellow-300 text-sm font-bold btn-press">
                            Buy
                        </button>
                    </div>
                `).join('');

                // Power-ups
                const powerupEl = document.getElementById('powerupItems');
                powerupEl.innerHTML = items.powerups.map(item => `
                    <div class="shop-item glass rounded-xl p-4 border border-white/10">
                        <div class="text-4xl mb-2 text-center">${item.icon}</div>
                        <h4 class="font-bold text-sm text-center mb-1">${item.name}</h4>
                        <p class="text-[10px] text-white/50 text-center mb-2">${item.duration}s duration</p>
                        <div class="flex items-center justify-center gap-1 text-yellow-400 font-bold mb-3">
                            <i class="fas fa-coins text-xs"></i> ${item.price}
                        </div>
                        <button onclick="buyItem('${item.id}')" class="w-full py-2 rounded-lg bg-yellow-500/20 text-yellow-300 text-sm font-bold btn-press">
                            Buy
                        </button>
                    </div>
                `).join('');
            },

            renderRobuxShop() {
                const data = DataSystem.getData();
                const items = data.shop.items;

                // Gamepasses
                const gamepassEl = document.getElementById('gamepassItems');
                gamepassEl.innerHTML = items.gamepasses.map(item => `
                    <div class="shop-item glass rounded-xl p-4 border border-purple-500/30 bg-purple-500/5">
                        <div class="flex items-start gap-3">
                            <div class="text-4xl">${item.icon}</div>
                            <div class="flex-1">
                                <h4 class="font-bold mb-1">${item.name}</h4>
                                <p class="text-xs text-white/60 mb-2">${item.description}</p>
                                <div class="flex flex-wrap gap-1 mb-3">
                                    ${item.benefits.map(b => `<span class="text-[10px] bg-purple-500/20 px-2 py-0.5 rounded-full text-purple-300">${b}</span>`).join('')}
                                </div>
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-1 text-purple-400 font-bold">
                                        <i class="fas fa-gem text-xs"></i> ${item.price}
                                    </div>
                                    <button onclick="buyRobuxItem('${item.id}')" class="px-4 py-1.5 rounded-lg bg-purple-500/20 text-purple-300 text-sm font-bold btn-press">
                                        Buy
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');

                // Dev Products
                const devProductEl = document.getElementById('devProductItems');
                devProductEl.innerHTML = items.devproducts.map(item => `
                    <div class="shop-item glass rounded-xl p-4 border border-white/10 text-center">
                        <div class="text-3xl mb-2">${item.icon}</div>
                        <h4 class="font-bold text-sm mb-1">${item.name}</h4>
                        <div class="flex items-center justify-center gap-1 text-purple-400 font-bold mb-3">
                            <i class="fas fa-gem text-xs"></i> ${item.price}
                        </div>
                        <button onclick="buyRobuxItem('${item.id}')" class="w-full py-2 rounded-lg bg-purple-500/20 text-purple-300 text-sm font-bold btn-press">
                            Buy
                        </button>
                    </div>
                `).join('');
            }
        };

        // ==================== APP STATE ====================
        let currentUser = null;
        let currentTool = 'select';
        let isAdmin = false;
        let studioScene, studioCamera, studioRenderer;

        // ==================== INITIALIZATION ====================
        window.onload = () => {
            DataSystem.init();
            
            // Simulate loading
            let progress = 0;
            const loadInterval = setInterval(() => {
                progress += Math.random() * 20;
                if (progress >= 100) {
                    progress = 100;
                    clearInterval(loadInterval);
                    setTimeout(() => {
                        document.getElementById('loadingScreen').classList.add('hidden');
                        checkSession();
                    }, 500);
                }
                document.getElementById('loadingBar').style.width = progress + '%';
            }, 200);
        };

        function checkSession() {
            const saved = localStorage.getItem('blockverse_session');
            if (saved) {
                try {
                    const session = JSON.parse(saved);
                    const account = DataSystem.getAccount(session.username);
                    if (account && account.password === session.passwordHash) {
                        loginUser(account);
                        return;
                    }
                } catch(e) {}
            }
            document.getElementById('authContainer').classList.remove('hidden');
        }

        function loginUser(account) {
            currentUser = account;
            isAdmin = account.isAdmin || account.isOwner;
            
            // Update UI
            document.getElementById('authContainer').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            
            // Show admin elements if applicable
            if (isAdmin) {
                document.getElementById('adminMenuBtn').classList.remove('hidden');
                document.getElementById('adminIndicator').classList.remove('hidden');
                document.getElementById('inGameAdminBtn').classList.remove('hidden');
                document.getElementById('menuRole').textContent = account.isOwner ? 'Game Owner' : 'Moderator';
            }
            
            updateProfileUI();
            ShopSystem.init();
            generateGames();
            initStudio();
            
            showSection('play');
            showToast(`Welcome back, ${account.username}!`);
        }

        function updateProfileUI() {
            if (!currentUser) return;
            
            document.getElementById('coinDisplay').textContent = currentUser.coins.toLocaleString();
            document.getElementById('robuxAmount').textContent = currentUser.robux.toLocaleString();
            document.getElementById('robuxDisplay').style.display = 'flex';
            document.getElementById('menuUsername').textContent = currentUser.username;
            document.getElementById('profileUsername').textContent = currentUser.username;
            document.getElementById('profileCoins').textContent = currentUser.coins.toLocaleString();
            document.getElementById('profileRobux').textContent = currentUser.robux.toLocaleString();
            document.getElementById('headerAvatar').style.backgroundColor = currentUser.avatarColor || '#4ECDC4';
        }

        // ==================== AUTH HANDLERS ====================
        function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            const account = DataSystem.getAccount(username);
            if (!account || account.password !== DataSystem.hashPassword(password)) {
                showToast('Invalid username or password', 'error');
                return;
            }
            
            // Save session
            localStorage.setItem('blockverse_session', JSON.stringify({
                username: account.username,
                passwordHash: account.password
            }));
            
            loginUser(account);
        }

        function handleRegister(e) {
            e.preventDefault();
            const username = document.getElementById('regUsername').value;
            const password = document.getElementById('regPassword').value;
            const confirm = document.getElementById('regConfirmPassword').value;
            
            if (password !== confirm) {
                showToast('Passwords do not match', 'error');
                return;
            }
            
            if (DataSystem.getAccount(username)) {
                showToast('Username already exists', 'error');
                return;
            }
            
            const account = DataSystem.createAccount(username, {
                fullName: document.getElementById('regName').value,
                username: username,
                birthday: document.getElementById('regBirthday').value,
                password: DataSystem.hashPassword(password),
                avatarColor: '#4ECDC4'
            });
            
            // Auto login
            localStorage.setItem('blockverse_session', JSON.stringify({
                username: account.username,
                passwordHash: account.password
            }));
            
            loginUser(account);
            showToast('Account created successfully!');
        }

        function showLogin() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
        }

        function showRegister() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
        }

        function logout() {
            localStorage.removeItem('blockverse_session');
            location.reload();
        }

        // ==================== UI FUNCTIONS ====================
        function showSection(section) {
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            document.getElementById(section + 'Section')?.classList.remove('hidden');
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active', 'opacity-100');
                btn.classList.add('opacity-60');
                if (btn.dataset.section === section) {
                    btn.classList.add('active', 'opacity-100');
                    btn.classList.remove('opacity-60');
                }
            });
            
            document.getElementById('profileMenu').classList.add('hidden');
            
            if (section === 'admin') {
                updateAdminPanel();
            }
        }

        function toggleProfileMenu() {
            document.getElementById('profileMenu').classList.toggle('hidden');
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show';
            
            if (type === 'error') toast.style.background = 'rgba(239, 68, 68, 0.9)';
            else if (type === 'success') toast.style.background = 'rgba(34, 197, 94, 0.9)';
            else toast.style.background = 'rgba(0, 0, 0, 0.9)';
            
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // ==================== STUDIO FUNCTIONS ====================
        function initStudio() {
            const canvas = document.getElementById('studioCanvas');
            studioScene = new THREE.Scene();
            studioScene.background = new THREE.Color(0x1a1a2e);
            
            studioCamera = new THREE.PerspectiveCamera(75, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
            studioCamera.position.set(10, 10, 10);
            studioCamera.lookAt(0, 0, 0);
            
            studioRenderer = new THREE.WebGLRenderer({ canvas, antialias: true });
            studioRenderer.setSize(canvas.clientWidth, canvas.clientHeight);
            studioRenderer.shadowMap.enabled = true;
            
            // Grid
            const gridHelper = new THREE.GridHelper(100, 100, 0x444444, 0x222222);
            studioScene.add(gridHelper);
            
            // Lighting
            const ambient = new THREE.AmbientLight(0xffffff, 0.4);
            studioScene.add(ambient);
            
            const dir = new THREE.DirectionalLight(0xffffff, 0.8);
            dir.position.set(10, 20, 10);
            studioScene.add(dir);
            
            // Baseplate
            const baseplate = new THREE.Mesh(
                new THREE.BoxGeometry(50, 1, 50),
                new THREE.MeshLambertMaterial({ color: 0x2ecc71 })
            );
            baseplate.position.y = -0.5;
            baseplate.receiveShadow = true;
            studioScene.add(baseplate);
            
            animateStudio();
        }

        function animateStudio() {
            requestAnimationFrame(animateStudio);
            studioRenderer.render(studioScene, studioCamera);
        }

        function selectTool(tool) {
            currentTool = tool;
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }

        function toggleScriptEditor() {
            document.getElementById('scriptEditor').classList.toggle('hidden');
        }

        function updateCodeHighlight() {
            const textarea = document.getElementById('codeInput');
            const highlight = document.getElementById('codeHighlight');
            
            let code = textarea.value
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
            
            // Simple syntax highlighting
            code = code
                .replace(/(\b(function|local|if|then|else|elseif|end|while|do|for|in|return|and|or|not|true|false|nil)\b)/g, '<span class="syntax-keyword">$1</span>')
                .replace(/(".*?"|'.*?')/g, '<span class="syntax-string">$1</span>')
                .replace(/\b(\d+)\b/g, '<span class="syntax-number">$1</span>')
                .replace(/(--.*$)/gm, '<span class="syntax-comment">$1</span>');
            
            highlight.innerHTML = code;
        }

        function syncScroll() {
            const textarea = document.getElementById('codeInput');
            const highlight = document.getElementById('codeHighlight');
            highlight.scrollTop = textarea.scrollTop;
            highlight.scrollLeft = textarea.scrollLeft;
        }

        function runScript() {
            const code = document.getElementById('codeInput').value;
            ScriptEngine.execute(code);
        }

        function stopScript() {
            ScriptEngine.stop();
        }

        function clearConsole() {
            ScriptEngine.clear();
        }

        function selectScript(name) {
            toggleScriptEditor();
        }

        // ==================== SHOP FUNCTIONS ====================
        function showShopTab(tab) {
            document.getElementById('coinsShop').classList.add('hidden');
            document.getElementById('robuxShop').classList.add('hidden');
            document.getElementById('coinsTab').classList.remove('bg-yellow-500/20', 'text-yellow-300', 'border-yellow-500/50');
            document.getElementById('coinsTab').classList.add('glass');
            document.getElementById('robuxTab').classList.remove('bg-purple-500/20', 'text-purple-300', 'border-purple-500/50');
            document.getElementById('robuxTab').classList.add('glass');
            
            if (tab === 'coins') {
                document.getElementById('coinsShop').classList.remove('hidden');
                document.getElementById('coinsTab').classList.add('bg-yellow-500/20', 'text-yellow-300', 'border-yellow-500/50');
                document.getElementById('coinsTab').classList.remove('glass');
            } else {
                document.getElementById('robuxShop').classList.remove('hidden');
                document.getElementById('robuxTab').classList.add('bg-purple-500/20', 'text-purple-300', 'border-purple-500/50');
                document.getElementById('robuxTab').classList.remove('glass');
            }
        }

        function buyItem(itemId) {
            const data = DataSystem.getData();
            const allItems = [...data.shop.items.clothing, ...data.shop.items.accessories, ...data.shop.items.powerups];
            const item = allItems.find(i => i.id === itemId);
            
            if (!item) return;
            
            if (currentUser.coins < item.price) {
                showToast('Not enough coins!', 'error');
                return;
            }
            
            currentUser.coins -= item.price;
            currentUser.inventory.push(item);
            DataSystem.updateAccount(currentUser.username, {
                coins: currentUser.coins,
                inventory: currentUser.inventory
            });
            
            DataSystem.addPurchase(currentUser.username, item);
            updateProfileUI();
            showToast(`Purchased ${item.name}!`, 'success');
        }

        function buyRobuxItem(itemId) {
            const data = DataSystem.getData();
            const allItems = [...data.shop.items.gamepasses, ...data.shop.items.devproducts];
            const item = allItems.find(i => i.id === itemId);
            
            if (!item) return;
            
            if (currentUser.robux < item.price) {
                showToast('Not enough Robux!', 'error');
                return;
            }
            
            currentUser.robux -= item.price;
            
            if (item.reward) {
                if (item.reward.coins) currentUser.coins += item.reward.coins;
            }
            
            if (item.benefits) {
                currentUser.gamepasses.push(item);
            }
            
            DataSystem.updateAccount(currentUser.username, {
                robux: currentUser.robux,
                coins: currentUser.coins,
                gamepasses: currentUser.gamepasses
            });
            
            updateProfileUI();
            showToast(`Purchased ${item.name}!`, 'success');
        }

        function buyRobux(amount) {
            // Simulate purchase
            setTimeout(() => {
                currentUser.robux += amount;
                DataSystem.updateAccount(currentUser.username, { robux: currentUser.robux });
                updateProfileUI();
                showToast(`Added ${amount} Robux!`, 'success');
            }, 1000);
        }

        // ==================== ADMIN FUNCTIONS ====================
        function updateAdminPanel() {
            // Update player list
            const list = document.getElementById('adminPlayerList');
            const mockPlayers = [
                { name: currentUser.username, id: 1, isAdmin: true },
                { name: 'Player2', id: 2, isAdmin: false },
                { name: 'BuilderPro', id: 3, isAdmin: false }
            ];
            
            list.innerHTML = mockPlayers.map(p => `
                <div class="flex items-center justify-between p-2 rounded-lg bg-white/5 hover:bg-white/10 cursor-pointer" onclick="selectPlayer('${p.name}')">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-400 to-purple-500 flex items-center justify-center text-xs font-bold">
                            ${p.name[0]}
                        </div>
                        <div>
                            <div class="font-bold text-sm ${p.isAdmin ? 'text-red-300' : ''}">${p.name} ${p.isAdmin ? '(Admin)' : ''}</div>
                            <div class="text-[10px] text-white/50">ID: ${p.id}</div>
                        </div>
                    </div>
                    <input type="checkbox" class="player-select w-4 h-4 rounded border-white/30 bg-white/10" data-player="${p.name}">
                </div>
            `).join('');
            
            document.getElementById('adminPlayerCount').textContent = mockPlayers.length;
        }

        function selectPlayer(name) {
            // Toggle checkbox
            const checkbox = document.querySelector(`[data-player="${name}"]`);
            if (checkbox) checkbox.checked = !checkbox.checked;
        }

        function adminAction(action) {
            const selected = Array.from(document.querySelectorAll('.player-select:checked')).map(cb => cb.dataset.player);
            
            if (selected.length === 0) {
                showToast('Select a player first', 'error');
                return;
            }
            
            const target = selected[0];
            
            switch(action) {
                case 'kick':
                    const reason = prompt('Kick reason:') || 'No reason';
                    AdminSystem.execute(`;kick ${target} ${reason}`);
                    break;
                case 'ban':
                    const duration = prompt('Ban duration (1d, 1w, perm):') || '1d';
                    const banReason = prompt('Ban reason:') || 'No reason';
                    AdminSystem.execute(`;ban ${target} ${duration} ${banReason}`);
                    break;
                case 'teleport':
                    const dest = prompt('Teleport to (player/location):') || target;
                    AdminSystem.execute(`;teleport ${target} ${dest}`);
                    break;
                case 'message':
                    const msg = prompt('Message:') || 'Hello';
                    showToast(`Messaged ${target}: ${msg}`);
                    break;
            }
        }

        function executeCommand() {
            const input = document.getElementById('adminCommand');
            const command = input.value.trim();
            
            if (!command) return;
            
            if (AdminSystem.execute(command)) {
                input.value = '';
            }
        }

        function toggleInGameAdmin() {
            document.getElementById('inGameAdminPanel').classList.toggle('hidden');
        }

        function quickAdmin(action) {
            switch(action) {
                case 'fly':
                    AdminSystem.execute(';fly me');
                    break;
                case 'speed':
                    AdminSystem.execute(';speed me 100');
                    break;
                case 'god':
                    AdminSystem.execute(';god me');
                    break;
                case 'invisible':
                    AdminSystem.execute(';invisible me');
                    break;
            }
        }

        function executeQuickCommand() {
            const input = document.getElementById('quickCommand');
            const command = input.value.trim();
            if (command) {
                AdminSystem.execute(command);
                input.value = '';
            }
        }

        // ==================== GAME FUNCTIONS ====================
        function generateGames() {
            const games = [
                { name: 'Skyblock Adventures', icon: 'ðŸï¸', players: 234, color: 'from-blue-400 to-blue-600' },
                { name: 'Obby Tower', icon: 'ðŸƒ', players: 567, color: 'from-red-400 to-red-600' },
                { name: 'Tycoon City', icon: 'ðŸ­', players: 123, color: 'from-green-400 to-green-600' },
                { name: 'Hide & Seek', icon: 'ðŸ™ˆ', players: 89, color: 'from-purple-400 to-purple-600' }
            ];
            
            document.getElementById('gamesGrid').innerHTML = games.map(g => `
                <div class="glass rounded-2xl overflow-hidden border border-white/10 btn-press" onclick="joinGame('${g.name}')">
                    <div class="h-24 bg-gradient-to-br ${g.color} flex items-center justify-center text-4xl">
                        ${g.icon}
                    </div>
                    <div class="p-3">
                        <h3 class="font-bold text-sm">${g.name}</h3>
                        <p class="text-[10px] text-white/50">ðŸ‘¥ ${g.players}</p>
                    </div>
                </div>
            `).join('');
        }

        function joinGame(name) {
            document.getElementById('app').classList.add('hidden');
            document.getElementById('gamePlayer').classList.remove('hidden');
            document.getElementById('gameCoins').textContent = currentUser.coins;
            
            // Init game scene
            initGameScene();
        }

        function exitGame() {
            document.getElementById('gamePlayer').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
        }

        function initGameScene() {
            const canvas = document.getElementById('gameCanvas');
            const scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB);
            
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 5, 10);
            
            const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            
            // Simple world
            const ground = new THREE.Mesh(
                new THREE.PlaneGeometry(100, 100),
                new THREE.MeshLambertMaterial({ color: 0x7CFC00 })
            );
            ground.rotation.x = -Math.PI / 2;
            scene.add(ground);
            
            const light = new THREE.DirectionalLight(0xffffff, 0.8);
            light.position.set(10, 20, 10);
            scene.add(light);
            scene.add(new THREE.AmbientLight(0xffffff, 0.4));
            
            function animate() {
                requestAnimationFrame(animate);
                renderer.render(scene, camera);
            }
            animate();
        }

        // Studio shortcuts
        function studioNew() {
            if (confirm('Create new game? Unsaved changes will be lost.')) {
                showToast('New game created');
            }
        }

        function studioSave() {
            showToast('Game saved!', 'success');
        }

        function studioPublish() {
            showToast('Game published!', 'success');
        }

        function studioUndo() {
            showToast('Undo');
        }

        function studioRedo() {
            showToast('Redo');
        }

        function studioPlay() {
            showToast('Testing game...');
        }

        function insertPart(type) {
            showToast(`Insert ${type}`);
        }

        // Handle resize
        window.addEventListener('resize', () => {
            if (studioCamera && studioRenderer) {
                const canvas = document.getElementById('studioCanvas');
                studioCamera.aspect = canvas.clientWidth / canvas.clientHeight;
                studioCamera.updateProjectionMatrix();
                studioRenderer.setSize(canvas.clientWidth, canvas.clientHeight);
            }
        });
    </script>
</body>
</html>
